<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Sauda Admin Panel</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- CSS Variables & Modern Reset --- */
        :root {
            /* Brand Colors */
            --primary-color: #10B981; /* Modern Emerald */
            --primary-dark: #059669;
            --primary-light: #D1FAE5;
            
            /* Sidebar Colors */
            --sidebar-bg: #1e293b; /* Slate 800 */
            --sidebar-text: #94a3b8;
            --sidebar-active-bg: #10B981;
            --sidebar-active-text: #ffffff;

            /* Functional Colors */
            --danger-color: #EF4444;
            --danger-bg: #FEE2E2;
            --success-color: #10B981;
            --success-bg: #D1FAE5;
            --warning-color: #F59E0B;
            --warning-bg: #FEF3C7;
            --info-color: #3B82F6;
            --info-bg: #DBEAFE;
            --upi-color: #8B5CF6; /* Violet */

            /* Layout Colors */
            --background-color: #F3F4F6; /* Light Gray */
            --card-bg: #ffffff;
            --text-color: #1F2937;
            --text-muted: #6B7280;
            
            /* Effects */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --transition: all 0.3s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 14px;
        }

        h1, h2, h3 { font-family: 'Poppins', sans-serif; color: var(--text-color); }

        /* --- Layout Structure --- */
        #app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Modern Sidebar --- */
        #sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            z-index: 20;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 25px 20px;
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-family: 'Poppins', sans-serif;
            letter-spacing: 0.5px;
        }

        .sidebar-nav {
            padding: 20px 15px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--sidebar-text);
            text-decoration: none;
            font-weight: 500;
            border-radius: var(--border-radius-sm);
            margin-bottom: 5px;
            transition: var(--transition);
            cursor: pointer;
        }

        .sidebar-nav a:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            transform: translateX(5px);
        }

        .sidebar-nav a.active {
            background: var(--sidebar-active-bg);
            color: var(--sidebar-active-text);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Special Style for SOS Tab */
        .sidebar-nav a[data-tab="sos"] {
            color: #FCA5A5; /* Light Red */
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        .sidebar-nav a[data-tab="sos"]:hover, .sidebar-nav a[data-tab="sos"].active {
            background: #EF4444;
            color: white;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        #logout-btn {
            margin: 20px;
            width: calc(100% - 40px);
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        #logout-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        /* --- Main Content Area --- */
        #main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            background-color: var(--background-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .header .logo {
            font-size: 1.8rem;
            color: #111827;
        }

        .header #user-info {
            background: white;
            padding: 8px 16px;
            border-radius: 30px;
            box-shadow: var(--shadow-sm);
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Cards --- */
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 25px;
            border: 1px solid rgba(0,0,0,0.02);
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }

        h2 {
            font-size: 1.25rem;
            color: #374151;
            border-bottom: 2px solid #F3F4F6;
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* --- Forms --- */
        .form-group, .form-row { margin-bottom: 20px; }
        .form-row { display: flex; flex-wrap: wrap; gap: 20px; }
        .form-row > div { flex: 1; min-width: 200px; }

        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            font-size: 0.9rem; 
            color: #4B5563; 
        }

        input, select, textarea { 
            width: 100%; 
            padding: 12px 15px; 
            border: 1px solid #E5E7EB; 
            border-radius: var(--border-radius-sm); 
            font-size: 0.95rem; 
            background-color: #F9FAFB;
            font-family: inherit; 
            transition: var(--transition); 
            color: #1F2937;
        }

        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary-color); 
            background-color: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); 
        }
        
        input[type="file"] {
            padding: 10px;
            background: white;
        }

        /* Color Input Specific Style */
        input[type="color"] {
            height: 50px;
            padding: 5px;
            cursor: pointer;
        }

        /* --- Buttons --- */
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: var(--border-radius-sm); 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.9rem; 
            transition: var(--transition); 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn:active { transform: scale(0.98); }

        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 6px 10px rgba(16, 185, 129, 0.3); }

        .btn-success { background: var(--success-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-danger:hover { background: #DC2626; }
        .btn-warning { background: var(--warning-color); color: white; }
        .btn-info { background: var(--info-color); color: white; }
        .btn-info:hover { background: #2563EB; }
        
        /* New Button Style for Subcat */
        .btn-subcat { background: #8B5CF6; color: white; }
        .btn-subcat:hover { background: #7C3AED; }

        /* --- Modern Tables --- */
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0 8px; /* Space between rows */ 
            margin-top: 10px; 
        }
        
        th { 
            text-align: left; 
            padding: 12px 15px; 
            color: var(--text-muted); 
            font-weight: 600; 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            border-bottom: 1px solid #E5E7EB;
        }

        td { 
            background: white; 
            padding: 16px 15px; 
            color: #374151; 
            border-top: 1px solid #F3F4F6; 
            border-bottom: 1px solid #F3F4F6; 
            font-size: 0.9rem;
        }
        
        td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; border-left: 1px solid #F3F4F6; }
        td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-right: 1px solid #F3F4F6; }

        tr { transition: var(--transition); }
        tbody tr:hover td { background-color: #F9FAFB; transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        
        /* SOS Table Row Style */
        .sos-row td {
            background-color: #FEF2F2 !important;
            border-color: #FECACA !important;
            color: #991B1B !important;
        }
        
        /* --- Grid for Splash/Banners --- */
        .splash-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; }
        
        .splash-card { 
            position: relative; 
            background: white; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-sm); 
            overflow: hidden; 
            transition: var(--transition); 
            border: 1px solid #E5E7EB;
        }
        
        .splash-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .splash-card img { height: 150px; width: 100%; object-fit: cover; }
        
        .delete-btn { 
            position: absolute; top: 8px; right: 8px; 
            background: white; color: var(--danger-color); 
            border: 1px solid #FEE2E2;
            border-radius: 50%; width: 32px; height: 32px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        .delete-btn:hover { background: var(--danger-color); color: white; }

        /* --- Status Badges --- */
        .status-badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            display: inline-block;
        }
        .status-requested, .status-pending { background: var(--warning-bg); color: #B45309; }
        .status-accepted, .status-processed, .status-settled, .status-active { background: var(--success-bg); color: #065F46; }
        .status-info { background: var(--info-bg); color: #1E40AF; }
        .status-completed { background: #F3F4F6; color: #374151; }
        .status-rejected, .status-failed, .status-inactive { background: var(--danger-bg); color: #991B1B; }
        .status-emergency { background: #FEE2E2; color: #EF4444; border: 1px solid #EF4444; animation: blink 1s infinite; }

        @keyframes blink { 50% { opacity: 0.6; } }

        /* --- Login Screen --- */
        #login-container {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 0 !important; /* Override inline style */
            background: linear-gradient(135deg, #10B981 0%, #047857 100%);
        }
        #login-container .card {
            width: 100%;
            max-width: 420px;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        #login-container h1 { color: var(--primary-dark); margin-bottom: 30px; }

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(17, 24, 39, 0.7); z-index: 100; 
            justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 16px; 
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
            box-shadow: 20px 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: modalPop 0.3s ease-out;
        }
        @keyframes modalPop {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .close-modal { background: none; border: none; font-size: 2rem; cursor: pointer; color: #9CA3AF; transition: 0.2s; line-height: 1;}
        .close-modal:hover { color: var(--danger-color); }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .error-message { 
            background: var(--danger-bg); color: #991B1B; 
            padding: 10px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 15px; border: 1px solid #FECACA;
        }
        .success-message { 
            background: var(--success-bg); color: #065F46; 
            padding: 10px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 15px; border: 1px solid #A7F3D0;
        }

        /* --- Mobile Toggle --- */
        .menu-toggle {
            display: none; background: white; border: none; color: var(--primary-color); 
            font-size: 24px; cursor: pointer; padding: 5px 10px; border-radius: 6px;
            position: absolute; left: 20px; top: 20px; z-index: 30; box-shadow: var(--shadow-md);
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            #sidebar { position: fixed; height: 100%; transform: translateX(-270px); }
            #sidebar.open { transform: translateX(0); }
            .menu-toggle { display: block; }
            #main-content { padding: 80px 15px 20px; }
            .header { flex-direction: column; align-items: flex-end; gap: 10px; margin-bottom: 20px;}
            .header .logo { display: none; } /* Hide logo on mobile header to save space */
        }
    </style>
</head>
<body>

    <div id="login-container" class="container">
        <div class="card">
            <h1 class="logo" style="text-align: center;">Admin Login</h1>
            <form id="login-form">
                <div id="login-error" class="error-message hidden"></div>
                <div class="form-group"><label for="email">Email Address</label><input type="email" id="email" placeholder="admin@quicksauda.com" required></div>
                <div class="form-group"><label for="password">Password</label><input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;">Sign In to Dashboard</button>
            </form>
        </div>
    </div>

    <div id="dashboard-container" class="hidden">
        <div id="app-container">
            
            <button class="menu-toggle" id="menu-toggle">‚ò∞</button>

            <div id="sidebar">
                <div class="sidebar-header">QUICK SAUDA</div>
                <nav class="sidebar-nav">
                    <a class="nav-link active" data-tab="categories">üìÇ Category Manager</a> 
                    <a class="nav-link" data-tab="splash">üé® Splash Manager</a>
                    <a class="nav-link" data-tab="banners">üñºÔ∏è Banner Manager</a>
                    <a class="nav-link" data-tab="coupons">üé´ Coupon Manager</a>
                    <a class="nav-link" data-tab="notifications">üîî Notifications</a>
                    <a class="nav-link" data-tab="returns">‚Ü©Ô∏è Customer Returns</a>
                    <a class="nav-link" data-tab="settlements">üí∞ Seller Settlements</a>
                    <a class="nav-link" data-tab="delivery">üõµ Delivery Boys</a>
                    <a class="nav-link" data-tab="drivers">üöñ Driver & Ride Control</a>
                    <a class="nav-link" data-tab="sos" style="font-weight: bold;">üö® SOS Monitor</a>
                    <a class="nav-link" data-tab="affiliate">üîó Affiliate Products</a>
                    <a class="nav-link" data-tab="locations" style="color: #EF4444; font-weight: 500;">üö´ Blocked Areas</a>
                    <a class="nav-link" data-tab="settings">‚öôÔ∏è App Settings</a>
                </nav>
                <button id="logout-btn" class="btn">Sign Out</button>
            </div>

            <div id="main-content">
                <div class="header">
                    <h1 class="logo">Overview</h1>
                    <div id="user-info">
                        <span style="background: #D1FAE5; color: #065F46; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">A</span>
                        Administrator
                    </div>
                </div>

                <div id="categories-section" class="tab-content">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>All Categories</h2>
                            <button onclick="openCategoryModal()" class="btn btn-primary">
                                + Add New Category
                            </button>
                        </div>

                        <div id="categories-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                            </div>
                    </div>
                </div>

                <div id="splash-section" class="tab-content hidden">
                    <div class="card">
                        <h2>Current Splash Screens</h2>
                        <div id="splash-grid" class="splash-grid"></div>
                    </div>
                    <div class="card">
                        <h2>Upload New Splash Image</h2>
                        <form id="upload-form">
                            <div id="upload-error" class="error-message hidden"></div>
                            <div class="form-row">
                                <div class="form-group"><label for="media-splash">Image File</label><input type="file" id="media-splash" name="media" accept="image/*" required></div>
                                <div class="form-group"><label for="title">Title (Optional)</label><input type="text" id="title" name="title" placeholder="e.g., Diwali Special"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload Image</button>
                        </form>
                    </div>
                </div>

                <div id="banners-section" class="tab-content hidden">
                    <div class="card">
                        <h2>Current Home Banners</h2>
                        <div style="margin-bottom: 15px; font-size: 0.85em; color: #666; display: flex; gap: 15px; align-items: center;">
                            <span style="display:flex; align-items:center; gap:5px;"><span style="width:10px; height:10px; background:var(--success-color); border-radius:50%;"></span> Active</span>
                            <span style="display:flex; align-items:center; gap:5px;"><span style="width:10px; height:10px; background:#ccc; border-radius:50%;"></span> Inactive</span>
                        </div>
                        <div id="banner-grid" class="splash-grid"></div>
                    </div>
                    <div class="card" id="banner-form-card">
                        <h2 id="banner-form-title">Upload New Banner</h2>
                        <form id="banner-upload-form">
                            <div id="banner-upload-error" class="error-message hidden"></div>
                            <input type="hidden" id="edit-banner-id">
                            <div class="form-group">
                                <label for="media-banner" id="media-banner-label">Banner Image File (Required)</label>
                                <input type="file" id="media-banner" name="media" accept="image/*">
                                <small style="color: #666; display: none; margin-top: 5px;" id="edit-image-hint">Leave empty to keep current image.</small>
                            </div>
                            <div class="form-row">
                                <div><label for="banner-title">Title/Link (Optional)</label><input type="text" id="banner-title" name="title" placeholder="e.g., Summer Sale Link"></div>
                                <div>
                                    <label for="banner-position">Position</label>
                                    <select id="banner-position" name="position">
                                        <option value="top">Hero Slider (Top)</option>
                                        <option value="middle">Mid Section</option>
                                        <option value="bottom">Bottom Section</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="banner-section">Section</label>
                                <select id="banner-section" name="section">
                                    <option value="home">Home Page</option>
                                    <option value="product">Product Page</option>
                                    <option value="service">Service Page</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="banner-active">Status</label>
                                <select id="banner-active" name="isActive">
                                    <option value="true" selected>Active (Visible)</option>
                                    <option value="false">Inactive (Hidden)</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button type="submit" class="btn btn-primary" id="banner-submit-btn">Upload Banner</button>
                                <button type="button" class="btn btn-warning hidden" id="banner-cancel-edit-btn">Cancel Edit</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="coupons-section" class="tab-content hidden">
                    <div class="card">
                        <h2>Create New Coupon</h2>
                        <form id="coupon-form">
                            <div id="coupon-error" class="error-message hidden"></div>
                            <div class="form-row">
                                <div><label for="code">Coupon Code</label><input type="text" id="code" name="code" placeholder="SUMMER25" required style="text-transform: uppercase; letter-spacing: 1px;"></div>
                                <div><label for="expiryDate">Expiry Date</label><input type="date" id="expiryDate" name="expiryDate" required></div>
                            </div>
                            <div class="form-row">
                                <div>
                                    <label for="discountType">Discount Type</label>
                                    <select id="discountType" name="discountType">
                                        <option value="percentage">Percentage (%)</option>
                                        <option value="fixed">Fixed Amount (‚Çπ)</option>
                                    </select>
                                </div>
                                <div><label for="discountValue">Value</label><input type="number" id="discountValue" name="discountValue" placeholder="e.g. 20" step="any" required></div>
                            </div>
                            <div class="form-row">
                                <div><label for="minPurchaseAmount">Min Purchase (Optional)</label><input type="number" id="minPurchaseAmount" name="minPurchaseAmount" step="any"></div>
                                <div><label for="maxDiscountAmount">Max Discount (for %)</label><input type="number" id="maxDiscountAmount" name="maxDiscountAmount" step="any"></div>
                            </div>
                            <button type="submit" class="btn btn-primary" style="margin-top: 15px;">Create Coupon</button>
                        </form>
                    </div>
                    <div class="card">
                        <h2>Active Coupons</h2>
                        <div id="coupon-list" style="overflow-x: auto;"></div>
                    </div>
                </div>
                
                <div id="notifications-section" class="tab-content hidden">
                    <div class="card">
                        <h2>Send Broadcast Notification</h2>
                        <form id="notification-form">
                            <div id="notification-status" class="hidden" style="margin-bottom: 15px;"></div>
                            <div class="form-group"><label for="notification-title">Title</label><input type="text" id="notification-title" name="title" required></div>
                            <div class="form-group"><label for="notification-message">Message</label><textarea id="notification-message" name="message" rows="4" required></textarea></div>
                            <div class="form-group">
                                <label style="margin-bottom: 10px; display: block;">When to send?</label>
                                <div style="display: flex; gap: 20px; margin-bottom: 15px; background: #f9fafb; padding: 15px; border-radius: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                        <input type="radio" name="sendType" value="now" checked onclick="toggleScheduleInput(false)"> 
                                        <strong>Send Now</strong>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                        <input type="radio" name="sendType" value="later" onclick="toggleScheduleInput(true)"> 
                                        <strong>Schedule for Later</strong>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group hidden" id="schedule-container" style="background: #eff6ff; padding: 15px; border-radius: 8px; border: 1px solid #dbeafe;">
                                <label for="scheduledAt" style="color: var(--info-color);">Select Date & Time</label>
                                <input type="datetime-local" id="scheduledAt" name="scheduledAt" style="background: white;">
                            </div>
                            <div class="form-row">
                                <div>
                                    <label for="notification-target">Target Audience</label>
                                    <select id="notification-target" name="target">
                                        <option value="all">All Users</option>
                                        <option value="users">Customers Only</option>
                                        <option value="sellers">Sellers Only</option>
                                        <option value="delivery_boys">Delivery Boys Only</option>
                                    </select>
                                </div>
                                <div><label for="notification-image">Image (Optional)</label><input type="file" id="notification-image" name="media" accept="image/*"></div>
                            </div>
                            <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 15px; padding: 12px;">Send Notification</button>
                        </form>
                    </div>
                </div>

                <div id="returns-section" class="tab-content hidden">
                    <div class="card">
                        <h2>Customer Return Requests</h2>
                        <div id="return-requests-list" style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Seller Name</th>
                                        <th>Amount</th>
                                        <th>Reason</th>
                                        <th>Payment Details</th> 
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="returns-table-body">
                                    <tr><td colspan="8">Loading return requests...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="settlements-section" class="tab-content hidden">
                    <div class="card">
                        <h2>Seller Payout Requests</h2>
                        <div style="background: var(--warning-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--warning-color);">
                             <strong style="color: #92400E;">How to Process:</strong><br>
                             <small style="color: #92400E;">1. Pay the seller using the <strong>UPI ID</strong> or Bank Details shown.<br>
                             2. Click "Settle Payment" and enter the Transaction ID.</small>
                        </div>
                        <div id="settlements-list" style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Req ID</th>
                                        <th>Seller Info</th>
                                        <th>Claim Amount</th>
                                        <th>UPI ID / Bank Details</th>
                                        <th>Date Requested</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="settlements-table-body">
                                    <tr><td colspan="7">Loading payouts...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="delivery-section" class="tab-content hidden">
                    <div class="card">
                        <h2>Registered Delivery Boys</h2>
                        <div id="delivery-boys-list" style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Pincodes</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="delivery-table-body">
                                    <tr><td colspan="5">Loading delivery boys...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="drivers-section" class="tab-content hidden">
                    <div class="card">
                        <h2>Live Driver Monitoring</h2>
                        <div style="margin-bottom: 15px;">
                            <button class="btn btn-primary" onclick="fetchDriversStatus()">Refresh List</button>
                        </div>
                        <div id="drivers-list" style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Vehicle</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Wallet Balance</th>
                                        <th>Locked?</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="drivers-table-body">
                                    <tr><td colspan="7" style="text-align:center;">Loading drivers...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="sos-section" class="tab-content hidden">
                    <div class="card" style="border-top: 5px solid var(--danger-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="color: var(--danger-color);">üö® SOS Alerts (Live)</h2>
                            <button class="btn btn-danger" onclick="fetchSOSAlerts()">Refresh Alerts</button>
                        </div>
                        <div id="sos-list" style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>User Name</th>
                                        <th>Phone</th>
                                        <th>Location</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="sos-table-body">
                                    <tr><td colspan="7" style="text-align:center;">Checking for emergency alerts...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="affiliate-section" class="tab-content hidden">
                    <div class="card">
                        <h2 id="aff-form-title">Add Affiliate Product</h2>
                        <form id="affiliate-form">
                            <div id="affiliate-error" class="error-message hidden"></div>
                            <input type="hidden" id="edit-affiliate-id">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Product Name</label>
                                    <input type="text" name="name" id="aff-name" placeholder="e.g. iPhone 15" required>
                                </div>
                                <div class="form-group">
                                    <label>Platform</label>
                                    <select name="platform" id="aff-platform">
                                        <option value="Amazon">Amazon</option>
                                        <option value="Flipkart">Flipkart</option>
                                        <option value="Myntra">Myntra</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Affiliate Link (URL)</label>
                                    <input type="url" name="affiliateLink" id="aff-link" placeholder="https://amzn.to/..." required>
                                </div>
                                <div class="form-group">
                                    <label>Product Image</label>
                                    <input type="file" name="media" id="aff-image" accept="image/*">
                                    <small id="aff-img-hint" style="display:none; color:#666;">Leave empty to keep current image</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Display Price (‚Çπ)</label>
                                    <input type="number" name="price" id="aff-price" required>
                                </div>
                                <div class="form-group">
                                    <label>Original Price (MRP)</label>
                                    <input type="number" name="originalPrice" id="aff-mrp">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Description</label>
                                <textarea name="description" id="aff-desc" rows="2" placeholder="Short description..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Status</label>
                                <select name="isActive" id="aff-active">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button type="submit" class="btn btn-primary" id="aff-submit-btn">Add Product</button>
                                <button type="button" class="btn btn-warning hidden" id="aff-cancel-btn">Cancel Edit</button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <h2>Affiliate Product List</h2>
                        <div id="affiliate-list-container" class="splash-grid">
                            </div>
                    </div>
                </div>

                <div id="locations-section" class="tab-content hidden">
                    <div class="card">
                        <div style="border-bottom: 2px solid #F3F4F6; padding-bottom: 15px; margin-bottom: 20px;">
                            <h2 style="color: #374151; border: none; margin: 0;">üî¢ Blocked Pincodes</h2>
                            <small style="color: #666;">Enter pincodes to completely stop delivery in those areas.</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Blocked Pincodes (Comma separated)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="setting-blocked-pincodes" placeholder="e.g. 800001, 800002" style="border-color: #FECACA; background-color: #FEF2F2;">
                                <button class="btn btn-primary" onclick="saveAppSettings()">Update & Save</button>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #ECFDF5; border-radius: 6px; border: 1px solid #A7F3D0; color: #065F46; font-size: 0.9em;">
                                <strong>üí° To Unblock:</strong> Simply delete the pincode from the box above and click "Update & Save".
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #F3F4F6; padding-bottom: 15px; margin-bottom: 20px;">
                            <div>
                                <h2 style="color: #374151; border: none; margin: 0;">üåç Blocked Geo-Zones (Map)</h2>
                                <small style="color: #666;">Block specific areas using a radius (e.g. for floods, riots, or non-serviceable streets).</small>
                            </div>
                            <button class="btn btn-danger" onclick="openZoneMapModal()">
                                üìç Manage Zones on Map
                            </button>
                        </div>

                        <div class="form-group">
                            <label>Current Active Blocked Zones (JSON Data)</label>
                            <textarea id="setting-blocked-zones" rows="4" 
                                placeholder='[]' 
                                style="font-family:monospace; font-size:0.85rem; border-color: #E5E7EB; background: #F9FAFB; color: #6B7280;" readonly></textarea>
                            <small style="color:#666;">This data is updated automatically via the Map Modal.</small>
                        </div>
                        
                        <div style="text-align: right;">
                            <button class="btn btn-primary" onclick="saveAppSettings()">Save Zone Changes</button>
                        </div>
                        
                        <div style="margin-top: 10px; padding: 10px; background: #ECFDF5; border-radius: 6px; border: 1px solid #A7F3D0; color: #065F46; font-size: 0.9em;">
                            <strong>üí° To Unblock Zones:</strong> Click "Manage Zones on Map", then click the red 'X' next to the zone you want to remove.
                        </div>
                    </div>
                </div>

                <div id="settings-section" class="tab-content hidden">
                    <div class="card">
                        <h2>General Settings</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Platform Commission Rate (%)</label>
                                <input type="number" id="setting-commission" step="0.01" min="0" max="1" placeholder="e.g. 0.05 for 5%">
                                <small style="color:#666;">Enter as decimal (0.05 = 5%, 0.10 = 10%)</small>
                            </div>
                            <div class="form-group">
                                <label>Product Creation Fee (‚Çπ)</label>
                                <input type="number" id="setting-product-fee" step="1" min="0" placeholder="e.g. 10">
                                <small style="color:#666;">Fee for seller wallet after free limit</small>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Delivery Configuration</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Global Delivery Radius (KM)</label>
                                <input type="number" id="setting-radius" step="0.1" min="0" placeholder="e.g. 50">
                                <small style="color:#666;">Max distance allowed for orders. Set 0 to disable radius check.</small>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 15px; margin-bottom: 10px; color: #374151;">Dynamic Delivery Pricing</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Base Charge (‚Çπ)</label>
                                <input type="number" id="setting-base-charge" placeholder="e.g. 20">
                                <small style="color:#666;">Fixed fee for initial distance.</small>
                            </div>
                            <div class="form-group">
                                <label>Base Distance (KM)</label>
                                <input type="number" id="setting-base-km" placeholder="e.g. 2">
                                <small style="color:#666;">Distance covered by Base Charge.</small>
                            </div>
                            <div class="form-group">
                                <label>Extra Fee Per KM (‚Çπ)</label>
                                <input type="number" id="setting-per-km-charge" placeholder="e.g. 10">
                                <small style="color:#666;">Charge for every KM after Base Dist.</small>
                            </div>
                        </div>
                        </div>

                    <div class="card">
                        <h2>App Design Theme (Dynamic Colors)</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Primary Color (Brand)</label>
                                <input type="color" id="theme-primary" value="#10B981">
                            </div>
                            <div class="form-group">
                                <label>Secondary Color (Highlights)</label>
                                <input type="color" id="theme-secondary" value="#F59E0B">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Background Color (App BG)</label>
                                <input type="color" id="theme-background" value="#F3F4F6">
                            </div>
                            <div class="form-group">
                                <label>Search Bar Color</label>
                                <input type="color" id="theme-search" value="#FFFFFF">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveAppSettings()">Save Settings & Apply</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="assign-delivery-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Approve Customer Return</h3>
                <button class="close-modal">√ó</button>
            </div>
            <div id="modal-error" class="error-message hidden"></div>
            <div id="approval-text" style="line-height: 1.6; color: #4B5563;">
                <p>By clicking <strong>'Approve Return'</strong>, you authorize the return process.</p>
                <p>The system will automatically create a <strong>'ReturnPending'</strong> job for a delivery boy.</p>
                <div style="margin-top: 20px; padding: 15px; background: #FFF7ED; border-radius: 8px; border-left: 4px solid #F97316;">
                    <strong style="color: #C2410C;">‚ö†Ô∏è Note:</strong> Ensure you have reviewed the refund reason and payment details before proceeding.
                </div>
            </div>
            <div style="text-align: right; margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-warning" onclick="closeApproveReturnModal()">Cancel</button>
                <button id="confirm-approval" class="btn btn-primary">Confirm & Approve</button>
            </div>
        </div>
    </div>

    <div id="driver-map-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h3>Driver Location Verification</h3>
                <button class="close-modal" onclick="closeBlockDriverModal()">√ó</button>
            </div>
            <p style="margin-bottom: 20px;">Please check the driver's location on the map before blocking/unblocking.</p>
            
            <a id="driver-map-link" href="#" target="_blank" class="btn btn-info" style="display: inline-block; margin-bottom: 20px; padding: 12px 20px;">
                üìç View Location on Google Maps
            </a>

            <div style="border-top: 1px solid #eee; padding-top: 20px; display: flex; justify-content: center; gap: 10px;">
                <button class="btn btn-warning" onclick="closeBlockDriverModal()">Cancel</button>
                <button id="confirm-block-driver-btn" class="btn btn-danger">Confirm Action</button>
            </div>
        </div>
    </div>

    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="cat-modal-title">Add Category</h3>
                <button class="close-modal" onclick="closeCategoryModal()">√ó</button>
            </div>
            <form id="category-form">
                <input type="hidden" id="cat-id">
                <div id="cat-error" class="error-message hidden"></div>

                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" name="name" id="cat-name" placeholder="e.g. Electrician or Vegetables" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select name="type" id="cat-type" style="background-color: #f8fafc; border-color: #cbd5e1;">
                            <option value="product">üì¶ Product (Items)</option>
                            <option value="service">üõ†Ô∏è Service (Booking)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">Select 'Service' for things like Doctor, Plumber, etc.</small>
                    </div>
                    <div class="form-group">
                        <label>Sort Order</label>
                        <input type="number" name="sortOrder" id="cat-sort" value="0">
                    </div>
                </div>

                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #15803d; font-size: 0.95rem;">üé® Design & Style (Flipkart Style)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Shape</label>
                            <select name="shape" id="cat-shape">
                                <option value="circle">Circle</option>
                                <option value="square">Square</option>
                                <option value="rectangle">Rectangle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Background Color</label>
                            <input type="color" name="bgColor" id="cat-bgColor" value="#ffffff" style="height: 40px; padding: 2px;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Text Color</label>
                            <input type="color" name="textColor" id="cat-textColor" value="#000000" style="height: 40px; padding: 2px;">
                        </div>
                        <div class="form-group">
                            <label>Border Color</label>
                            <input type="color" name="borderColor" id="cat-borderColor" value="#ffffff" style="height: 40px; padding: 2px;">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select name="isActive" id="cat-active">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Category Image/Icon</label>
                    <input type="file" name="image" id="cat-image" accept="image/*">
                    <small id="cat-img-hint" style="display:none; color:#666;">Leave empty to keep current image.</small>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 15px;">Save Category</button>
            </form>
        </div>
    </div>

    <div id="subcategory-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Manage Subcategories: <span id="subcat-parent-name" style="color: var(--primary-color);"></span></h3>
                <button class="close-modal" onclick="closeSubCategoryModal()">√ó</button>
            </div>
            
            <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                <h4 style="margin-bottom: 10px; font-size: 0.95rem;">Add New Subcategory</h4>
                <form id="subcategory-add-form" style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                    <input type="hidden" id="subcat-parent-id">
                    <div style="flex: 1; min-width: 150px;">
                        <label style="font-size: 0.8rem;">Name</label>
                        <input type="text" id="subcat-new-name" placeholder="e.g. Mens T-Shirts" required style="padding: 8px;">
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                         <label style="font-size: 0.8rem;">Image</label>
                         <input type="file" id="subcat-new-image" accept="image/*" style="padding: 5px; background: white;" required>
                    </div>
                    <button type="submit" class="btn btn-success" style="padding: 9px 15px;">Add</button>
                </form>
            </div>

            <div id="subcat-list-container">
                <table style="font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th style="padding: 8px;">Image</th>
                            <th style="padding: 8px;">Name</th>
                            <th style="padding: 8px; text-align: right;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="subcat-list-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="zone-map-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h3>Manage Blocked Zones</h3>
                <button class="close-modal" onclick="closeZoneMapModal()">√ó</button>
            </div>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;">1. Find Location</h4>
                        
                        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                            <input type="text" id="zone-search-input" placeholder="Search Place (e.g. Gandhi Maidan)" style="flex: 1;">
                            <button class="btn btn-info" onclick="searchLocation()" style="padding: 8px;">üîç</button>
                        </div>
                        <button class="btn btn-warning" onclick="useLiveLocation()" style="width: 100%; margin-bottom: 15px; background: #fff; border: 1px solid #F59E0B; color: #F59E0B;">
                            üìç Use My Current Location
                        </button>
    
                        <h4 style="margin-bottom: 10px; border-top: 1px solid #e5e7eb; padding-top: 10px;">2. Define Zone</h4>
                        <div class="form-group">
                            <label>Reason</label>
                            <input type="text" id="zone-reason" placeholder="e.g. Heavy Rain / Riots">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Lat</label>
                                <input type="text" id="zone-lat" readonly>
                            </div>
                            <div class="form-group">
                                <label>Lng</label>
                                <input type="text" id="zone-lng" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Radius (KM): <span id="radius-val">1.0</span> km</label>
                            <input type="range" id="zone-radius" min="0.5" max="10" step="0.1" value="1" oninput="updateCirclePreview()">
                        </div>
                        <button class="btn btn-primary" onclick="addZoneToList()" style="width: 100%;">+ Add Blocked Zone</button>
                    </div>
    
                    <div>
                        <h4>Active Zones List</h4>
                        <ul id="zones-list-ul" style="list-style: none; padding: 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;">
                            </ul>
                    </div>
                </div>
    
                <div style="flex: 2; min-width: 300px;">
                    <div id="zone-map" style="height: 550px; width: 100%; border-radius: 8px; border: 2px solid #ddd;"></div>
                </div>
            </div>
    
            <div style="text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <button class="btn btn-warning" onclick="closeZoneMapModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveZonesToSettings()">Save Zones</button>
            </div>
        </div>
    </div>

    <script>
        // ================================================================
        // IMPORTANT: Replace with your actual live server URL
        // ================================================================
        const API_BASE_URL = 'https://hdvideo-1.onrender.com'; 

        // --- DOM Elements References ---
        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        
        const navLinks = document.querySelectorAll('.sidebar-nav .nav-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');

        // Splash & Banner Elements
        const uploadForm = document.getElementById('upload-form');
        const splashGrid = document.getElementById('splash-grid');
        const uploadError = document.getElementById('upload-error');
        const bannerUploadForm = document.getElementById('banner-upload-form');
        const bannerGrid = document.getElementById('banner-grid');
        const bannerUploadError = document.getElementById('banner-upload-error');
        const bannerFormTitle = document.getElementById('banner-form-title');
        const bannerSubmitBtn = document.getElementById('banner-submit-btn');
        const bannerCancelEditBtn = document.getElementById('banner-cancel-edit-btn');
        const editBannerIdInput = document.getElementById('edit-banner-id');
        const mediaBannerInput = document.getElementById('media-banner');
        const mediaBannerLabel = document.getElementById('media-banner-label');
        const editImageHint = document.getElementById('edit-image-hint');
        const bannerPositionSelect = document.getElementById('banner-position');
        const bannerActiveSelect = document.getElementById('banner-active');
        const bannerTitleInput = document.getElementById('banner-title');
        
        // Coupon, Notif, Return, Settlement Elements
        const couponForm = document.getElementById('coupon-form');
        const couponList = document.getElementById('coupon-list');
        const couponError = document.getElementById('coupon-error');
        const notificationForm = document.getElementById('notification-form');
        const notificationStatus = document.getElementById('notification-status');
        const returnsTableBody = document.getElementById('returns-table-body');
        const settlementsTableBody = document.getElementById('settlements-table-body'); 
        const deliveryTableBody = document.getElementById('delivery-table-body');
        const driversTableBody = document.getElementById('drivers-table-body');
        const sosTableBody = document.getElementById('sos-table-body'); 

        // Modal elements
        const assignDeliveryModal = document.getElementById('assign-delivery-modal');
        const driverMapModal = document.getElementById('driver-map-modal'); 
        const confirmApprovalBtn = document.getElementById('confirm-approval');
        const closeModalBtn = document.querySelector('.close-modal');
        const modalError = document.getElementById('modal-error');

        // Subcategory Modal Elements
        const subCategoryModal = document.getElementById('subcategory-modal');
        const subCatParentNameDisplay = document.getElementById('subcat-parent-name');
        const subCatParentIdInput = document.getElementById('subcat-parent-id');
        const subCatAddForm = document.getElementById('subcategory-add-form');
        const subCatListBody = document.getElementById('subcat-list-body');

        // State variables
        let currentOrderId = null;
        let targetDriverId = null; 
        let targetDriverAction = null; 

        // ==========================================
        // --- Core Authentication and Layout ---
        // ==========================================
        const handleLogin = async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (!response.ok || data.user?.role !== 'admin') {
                    throw new Error(data.message || 'Login failed. Ensure you are an admin.');
                }
                localStorage.setItem('admin_token', data.token);
                showDashboard();
            } catch (error) {
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            }
        };

        const handleLogout = () => {
            localStorage.removeItem('admin_token');
            showLogin();
        };

        const showLogin = () => {
            loginContainer.classList.remove('hidden');
            dashboardContainer.classList.add('hidden');
        };

        const showDashboard = () => {
            loginContainer.classList.add('hidden');
            dashboardContainer.classList.remove('hidden');
            const activeTab = document.querySelector('.sidebar-nav .nav-link.active') || navLinks[0];
            if(activeTab) activeTab.click(); 
        };
        
        const toggleSidebar = () => sidebar.classList.toggle('open');

        // Tab Navigation Logic
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) sidebar.classList.remove('open');
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const tab = link.getAttribute('data-tab');
                
                tabContents.forEach(content => {
                    content.id === `${tab}-section` ? content.classList.remove('hidden') : content.classList.add('hidden');
                });

                if (tab === 'categories') fetchCategories(); 
                if (tab === 'splash') fetchSplashScreens();
                if (tab !== 'banners') resetBannerForm();
                if (tab === 'banners') fetchBanners(); 
                if (tab === 'coupons') fetchCoupons();
                if (tab === 'returns') fetchReturnRequests();
                if (tab === 'settlements') fetchSettlements(); 
                if (tab === 'delivery') fetchDeliveryBoys();
                if (tab === 'drivers') fetchDriversStatus(); 
                if (tab === 'sos') fetchSOSAlerts(); 
                if (tab === 'affiliate') fetchAffiliateProducts();
                
                // Fetch Settings OR Locations (both use the same API endpoint)
                if (tab === 'settings' || tab === 'locations') fetchAppSettings(); 
            });
        });

        // ==========================================
        // --- ‚úÖ APP SETTINGS LOGIC (UPDATED) ---
        // ==========================================
        const fetchAppSettings = async () => {
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                // Populate Commission & Fee
                if(document.getElementById('setting-commission'))
                    document.getElementById('setting-commission').value = data.platformCommissionRate;
                if(document.getElementById('setting-product-fee'))
                    document.getElementById('setting-product-fee').value = data.productCreationFee || 10;

                // ‚úÖ Populate Delivery Config (Radius, Pincodes, Zones, Pricing)
                if (data.deliveryConfig) {
                    if(document.getElementById('setting-radius'))
                        document.getElementById('setting-radius').value = data.deliveryConfig.globalRadiusKm || 0;
                    
                    // NEW: Populate Dynamic Pricing Fields
                    if(document.getElementById('setting-base-charge'))
                        document.getElementById('setting-base-charge').value = data.deliveryConfig.baseCharge || 20;
                    if(document.getElementById('setting-base-km'))
                        document.getElementById('setting-base-km').value = data.deliveryConfig.baseKm || 2;
                    if(document.getElementById('setting-per-km-charge'))
                        document.getElementById('setting-per-km-charge').value = data.deliveryConfig.extraPerKmCharge || 10;

                    // Populate Blocked Pincodes (Array -> Comma String)
                    if(document.getElementById('setting-blocked-pincodes')) {
                        if(data.deliveryConfig.blockedPincodes && data.deliveryConfig.blockedPincodes.length > 0) {
                            document.getElementById('setting-blocked-pincodes').value = data.deliveryConfig.blockedPincodes.join(', ');
                        } else {
                            document.getElementById('setting-blocked-pincodes').value = '';
                        }
                    }

                    // Populate Blocked Zones (JSON Array -> String)
                    if(document.getElementById('setting-blocked-zones')) {
                        if(data.deliveryConfig.blockedZones && data.deliveryConfig.blockedZones.length > 0) {
                            document.getElementById('setting-blocked-zones').value = JSON.stringify(data.deliveryConfig.blockedZones, null, 2);
                        } else {
                            document.getElementById('setting-blocked-zones').value = '';
                        }
                    }
                }

                // Populate Theme Colors (with defaults if missing)
                if (data.theme) {
                    if(document.getElementById('theme-primary'))
                        document.getElementById('theme-primary').value = data.theme.primaryColor || '#10B981';
                    if(document.getElementById('theme-secondary'))
                        document.getElementById('theme-secondary').value = data.theme.secondaryColor || '#F59E0B';
                    if(document.getElementById('theme-background'))
                        document.getElementById('theme-background').value = data.theme.backgroundColor || '#F3F4F6';
                    if(document.getElementById('theme-search'))
                        document.getElementById('theme-search').value = data.theme.searchBarColor || '#FFFFFF';
                }
            } catch (err) {
                console.error("Error fetching settings", err);
            }
        };

        window.saveAppSettings = async () => {
            const token = localStorage.getItem('admin_token');
            
            // Collect values safely (check if element exists)
            const commissionEl = document.getElementById('setting-commission');
            const productFeeEl = document.getElementById('setting-product-fee');
            const radiusEl = document.getElementById('setting-radius'); 
            const blockedPinsEl = document.getElementById('setting-blocked-pincodes'); 
            const blockedZonesEl = document.getElementById('setting-blocked-zones'); 
            
            // New Pricing Elements
            const baseChargeEl = document.getElementById('setting-base-charge');
            const baseKmEl = document.getElementById('setting-base-km');
            const perKmChargeEl = document.getElementById('setting-per-km-charge');

            const themePrimary = document.getElementById('theme-primary');
            
            const payload = {};

            if(commissionEl) payload.platformCommissionRate = commissionEl.value;
            if(productFeeEl) payload.productCreationFee = productFeeEl.value;
            
            // Delivery Radius
            if(radiusEl) payload.deliveryRadius = radiusEl.value;
            
            // Delivery Pricing (Send to backend update route)
            if(baseChargeEl) payload.deliveryBaseCharge = baseChargeEl.value;
            if(baseKmEl) payload.deliveryBaseKm = baseKmEl.value;
            if(perKmChargeEl) payload.deliveryPerKmCharge = perKmChargeEl.value;

            if(blockedPinsEl) payload.blockedPincodes = blockedPinsEl.value;
            if(blockedZonesEl) payload.blockedZones = blockedZonesEl.value;

            if(themePrimary) {
                payload.theme = {
                    primaryColor: document.getElementById('theme-primary').value,
                    secondaryColor: document.getElementById('theme-secondary').value,
                    backgroundColor: document.getElementById('theme-background').value,
                    searchBarColor: document.getElementById('theme-search').value
                };
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/settings`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if(!response.ok) throw new Error('Update failed');
                alert("Settings/Locations Updated Successfully!");
                fetchAppSettings(); // Refresh data
            } catch(err) {
                alert(err.message);
            }
        };

        // ==========================================
        // --- üåç GEO-FENCING MAP LOGIC (UPDATED) ---
        // ==========================================

        let mapInstance = null;
        let currentPreviewCircle = null;
        let tempZones = []; 

        // Open Modal
        window.openZoneMapModal = () => {
            document.getElementById('zone-map-modal').style.display = 'flex';
            
            // Load existing zones
            const existingJson = document.getElementById('setting-blocked-zones').value;
            try {
                tempZones = existingJson ? JSON.parse(existingJson) : [];
            } catch (e) {
                tempZones = [];
            }
            renderZonesList();

            // Initialize Map
            setTimeout(() => {
                if (mapInstance) mapInstance.remove();
                
                // Default View: Patna
                mapInstance = L.map('zone-map').setView([25.5941, 85.1376], 12);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(mapInstance);

                // Click to set point
                mapInstance.on('click', function(e) {
                    setMapPoint(e.latlng.lat, e.latlng.lng);
                });

                // Draw existing zones
                tempZones.forEach(zone => {
                    L.circle([zone.lat, zone.lng], {
                        color: 'red',
                        fillColor: '#f03',
                        fillOpacity: 0.3,
                        radius: zone.radiusKm * 1000
                    }).addTo(mapInstance).bindPopup(`<b>${zone.reason}</b>`);
                });

            }, 200);
        };

        window.closeZoneMapModal = () => {
            document.getElementById('zone-map-modal').style.display = 'none';
        };

        // Helper: Set inputs and update map view
        function setMapPoint(lat, lng) {
            document.getElementById('zone-lat').value = lat.toFixed(6);
            document.getElementById('zone-lng').value = lng.toFixed(6);
            
            // Pan map to location
            mapInstance.setView([lat, lng], 14);
            updateCirclePreview();
        }

        // üîç Search Location using OpenStreetMap API (Nominatim)
        window.searchLocation = async () => {
            const query = document.getElementById('zone-search-input').value;
            if (!query) return alert("Please enter a place name.");

            const btn = document.querySelector('.btn-info'); // Search button
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚åõ';

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    setMapPoint(lat, lng);
                } else {
                    alert("Location not found. Try a different name.");
                }
            } catch (error) {
                alert("Search failed. Check internet connection.");
            } finally {
                btn.innerHTML = originalText;
            }
        };

        // üìç Get Live Location from Browser
        window.useLiveLocation = () => {
            if (!navigator.geolocation) {
                return alert("Geolocation is not supported by your browser.");
            }
            
            // Show loading state on button
            const btn = document.querySelector('button[onclick="useLiveLocation()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Getting Location...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    setMapPoint(lat, lng);
                    btn.innerHTML = originalText;
                },
                (error) => {
                    alert("Unable to retrieve your location. Ensure location permission is allowed.");
                    btn.innerHTML = originalText;
                }
            );
        };

        window.updateCirclePreview = () => {
            const lat = parseFloat(document.getElementById('zone-lat').value);
            const lng = parseFloat(document.getElementById('zone-lng').value);
            const radiusKm = parseFloat(document.getElementById('zone-radius').value);

            document.getElementById('radius-val').textContent = radiusKm;

            if (!lat || !lng) return;

            if (currentPreviewCircle) {
                mapInstance.removeLayer(currentPreviewCircle);
            }

            currentPreviewCircle = L.circle([lat, lng], {
                color: 'blue',
                fillColor: '#30f',
                fillOpacity: 0.2,
                radius: radiusKm * 1000
            }).addTo(mapInstance);
        };

        window.addZoneToList = () => {
            const lat = document.getElementById('zone-lat').value;
            const lng = document.getElementById('zone-lng').value;
            const radius = document.getElementById('zone-radius').value;
            const reason = document.getElementById('zone-reason').value;

            if (!lat || !lng || !reason) {
                alert("Please set a location (Search/Click/Live) and enter a reason.");
                return;
            }

            tempZones.push({
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                radiusKm: parseFloat(radius),
                reason: reason
            });

            // Reset inputs
            document.getElementById('zone-reason').value = '';
            
            // Show red circle for the added zone
            L.circle([lat, lng], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: radius * 1000
            }).addTo(mapInstance);

            renderZonesList();
        };

        window.removeZone = (index) => {
            tempZones.splice(index, 1);
            renderZonesList();
        };

        function renderZonesList() {
            const ul = document.getElementById('zones-list-ul');
            ul.innerHTML = '';
            
            tempZones.forEach((zone, index) => {
                const li = document.createElement('li');
                li.style.padding = '8px';
                li.style.borderBottom = '1px solid #eee';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.innerHTML = `
                    <span style="font-size:0.9em;"><b>${zone.reason}</b> (${zone.radiusKm}km)</span>
                    <button onclick="removeZone(${index})" style="color:red; background:none; border:none; cursor:pointer;">‚úï</button>
                `;
                ul.appendChild(li);
            });
        }

        window.saveZonesToSettings = () => {
            const jsonString = JSON.stringify(tempZones, null, 2);
            document.getElementById('setting-blocked-zones').value = jsonString;
            closeZoneMapModal();
        };

        // ==========================================
        // --- ‚úÖ CATEGORY MANAGER LOGIC ---
        // ==========================================
        const categoriesListEl = document.getElementById('categories-list');
        const categoryModal = document.getElementById('category-modal');
        const categoryForm = document.getElementById('category-form');
        const catError = document.getElementById('cat-error');

        const fetchCategories = async () => {
            const token = localStorage.getItem('admin_token');
            if (!token) return handleLogout();
            
            categoriesListEl.innerHTML = '<p>Loading categories...</p>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/categories`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const categories = await response.json();
                renderCategories(categories);
            } catch (error) {
                console.error(error);
                categoriesListEl.innerHTML = '<p class="error-message">Failed to load categories.</p>';
            }
        };

        const renderCategories = (categories) => {
            categoriesListEl.innerHTML = '';
            if (!categories || categories.length === 0) {
                categoriesListEl.innerHTML = '<p>No categories found.</p>';
                return;
            }

            categories.forEach(cat => {
                const card = document.createElement('div');
                card.style.cssText = `background: ${cat.bgColor || 'white'}; border: 2px solid ${cat.borderColor || '#e5e7eb'}; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);`;
                
                const typeBadge = cat.type === 'service' 
                    ? `<span style="background: #F3E8FF; color: #7E22CE; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; border: 1px solid #D8B4FE;">SERVICE</span>`
                    : `<span style="background: #DBEAFE; color: #1E40AF; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; border: 1px solid #93C5FD;">PRODUCT</span>`;

                const statusDot = cat.isActive 
                    ? `<span style="width: 8px; height: 8px; background: #10B981; border-radius: 50%; display: inline-block;"></span>` 
                    : `<span style="width: 8px; height: 8px; background: #EF4444; border-radius: 50%; display: inline-block;"></span>`;

                const catDataSafe = encodeURIComponent(JSON.stringify(cat));

                let imgRadius = '8px';
                if(cat.shape === 'circle') imgRadius = '50%';
                if(cat.shape === 'square') imgRadius = '0';

                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="${cat.image?.url || 'https://placehold.co/50'}" style="width: 50px; height: 50px; border-radius: ${imgRadius}; object-fit: cover; background: #f3f4f6;">
                        <div>
                            <h4 style="margin: 0 0 4px 0; font-size: 1rem; color: ${cat.textColor || '#000'}">${cat.name}</h4>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${typeBadge}
                                <span style="font-size: 0.8rem; color: #666; display: flex; align-items: center; gap: 4px;">${statusDot} ${cat.isActive ? 'Active' : 'Inactive'}</span>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px; margin-top: 5px; justify-content: flex-end;">
                        <button class="btn btn-subcat" style="padding: 6px 12px; font-size: 0.8rem;" onclick="openSubCategoryModal('${cat._id}', '${cat.name}')">üìÇ Subcats</button>
                        <button class="btn btn-info" style="padding: 6px 10px;" onclick="openCategoryModal('${catDataSafe}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger" style="padding: 6px 10px;" onclick="deleteCategory('${cat._id}')">üóëÔ∏è</button>
                    </div>
                `;
                categoriesListEl.appendChild(card);
            });
        };

        window.openCategoryModal = (catDataString = null) => {
            catError.classList.add('hidden');
            categoryForm.reset();
            
            if (catDataString) {
                const cat = JSON.parse(decodeURIComponent(catDataString));
                document.getElementById('cat-modal-title').textContent = 'Edit Category';
                document.getElementById('cat-id').value = cat._id;
                document.getElementById('cat-name').value = cat.name;
                document.getElementById('cat-type').value = cat.type || 'product';
                document.getElementById('cat-sort').value = cat.sortOrder || 0;
                document.getElementById('cat-active').value = cat.isActive ? 'true' : 'false';
                
                document.getElementById('cat-shape').value = cat.shape || 'circle';
                document.getElementById('cat-bgColor').value = cat.bgColor || '#ffffff';
                document.getElementById('cat-textColor').value = cat.textColor || '#000000';
                document.getElementById('cat-borderColor').value = cat.borderColor || '#ffffff';

                document.getElementById('cat-image').required = false;
                document.getElementById('cat-img-hint').style.display = 'block';
            } else {
                document.getElementById('cat-modal-title').textContent = 'Add New Category';
                document.getElementById('cat-id').value = '';
                document.getElementById('cat-type').value = 'product'; 
                document.getElementById('cat-active').value = 'true';
                
                document.getElementById('cat-shape').value = 'circle';
                document.getElementById('cat-bgColor').value = '#ffffff';
                document.getElementById('cat-textColor').value = '#000000';
                document.getElementById('cat-borderColor').value = '#ffffff';

                document.getElementById('cat-image').required = true;
                document.getElementById('cat-img-hint').style.display = 'none';
            }
            categoryModal.style.display = 'flex';
        };

        window.closeCategoryModal = () => {
            categoryModal.style.display = 'none';
        };

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            catError.classList.add('hidden');
            const token = localStorage.getItem('admin_token');
            
            const formData = new FormData(categoryForm);
            const id = document.getElementById('cat-id').value;
            const isEdit = !!id;

            formData.delete('id'); 

            try {
                let url = `${API_BASE_URL}/api/admin/categories`;
                let method = 'POST';

                if (isEdit) {
                    url = `${API_BASE_URL}/api/admin/categories/${id}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Operation failed');

                alert(isEdit ? 'Category Updated!' : 'Category Created!');
                closeCategoryModal();
                fetchCategories();

            } catch (error) {
                catError.textContent = error.message;
                catError.classList.remove('hidden');
            }
        });

        window.deleteCategory = async (id) => {
            if(!confirm('Are you sure? Deleting a category might affect products attached to it.')) return;
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/categories/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Delete failed');
                }
                
                fetchCategories();
            } catch (error) {
                alert(error.message);
            }
        };

        // ==========================================
        // --- ‚úÖ SUBCATEGORY MANAGER LOGIC ---
        // ==========================================
        window.openSubCategoryModal = (parentId, parentName) => {
            subCatParentNameDisplay.textContent = parentName;
            subCatParentIdInput.value = parentId; 
            subCatAddForm.reset();
            subCatListBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Loading...</td></tr>';
            subCategoryModal.style.display = 'flex';
            fetchSubCategories(parentId);
        };

        window.closeSubCategoryModal = () => {
            subCategoryModal.style.display = 'none';
        };

        const fetchSubCategories = async (categoryId) => {
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/subcategories?categoryId=${categoryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(!response.ok) throw new Error('Failed to load');
                const subcats = await response.json();
                renderSubCategories(subcats);
            } catch (err) {
                console.error(err);
                subCatListBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:red;">Error loading subcategories.</td></tr>';
            }
        };

        const renderSubCategories = (subcats) => {
            subCatListBody.innerHTML = '';
            if(!subcats || subcats.length === 0) {
                subCatListBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 15px; color: #666;">No subcategories yet.</td></tr>';
                return;
            }

            subcats.forEach(sub => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 8px;"><img src="${sub.image?.url || 'https://placehold.co/40'}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover;"></td>
                    <td style="padding: 8px; font-weight: 500;">${sub.name}</td>
                    <td style="padding: 8px; text-align: right;">
                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.75rem;" onclick="deleteSubCategory('${sub._id}')">üóëÔ∏è</button>
                    </td>
                `;
                subCatListBody.appendChild(tr);
            });
        };

        subCatAddForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('admin_token');
            const categoryId = subCatParentIdInput.value;
            const name = document.getElementById('subcat-new-name').value;
            const imageFile = document.getElementById('subcat-new-image').files[0];

            if(!imageFile) { alert("Image is required"); return; }

            const formData = new FormData();
            formData.append('categoryId', categoryId); 
            formData.append('name', name);
            formData.append('image', imageFile);

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/subcategories`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await response.json();
                if(!response.ok) throw new Error(data.message || 'Failed to add');
                
                subCatAddForm.reset();
                fetchSubCategories(categoryId);
            } catch(err) {
                alert(err.message);
            }
        });

        window.deleteSubCategory = async (id) => {
            if(!confirm("Delete this subcategory?")) return;
            const token = localStorage.getItem('admin_token');
            const parentId = subCatParentIdInput.value;
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/subcategories/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(!response.ok) throw new Error('Failed to delete');
                fetchSubCategories(parentId);
            } catch(err) {
                alert(err.message);
            }
        };

        // ==========================================
        // --- Splash Manager Functions ---
        // ==========================================
        const fetchSplashScreens = async () => {
            const token = localStorage.getItem('admin_token');
            if (!token) return handleLogout();
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/splash`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401) return handleLogout();
                const splashes = await response.json();
                renderSplashScreens(splashes);
            } catch (error) { console.error('Error fetching splashes:', error); }
        };

        const handleUpload = async (e) => {
            e.preventDefault();
            uploadError.classList.add('hidden');
            const token = localStorage.getItem('admin_token');
            const formData = new FormData(uploadForm);
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/splash`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Upload failed.');
                uploadForm.reset();
                fetchSplashScreens();
            } catch (error) {
                uploadError.textContent = error.message;
                uploadError.classList.remove('hidden');
            }
        };

        const handleDeleteSplash = async (id) => {
            if (!confirm('Are you sure?')) return;
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/splash/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to delete.');
                fetchSplashScreens();
            } catch (error) { alert(error.message); }
        };

        const renderSplashScreens = (splashes) => {
            splashGrid.innerHTML = '';
            if (!splashes || splashes.length === 0) {
                splashGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #777;">No splash screens found.</p>';
                return;
            }
            splashes.forEach(splash => {
                const card = document.createElement('div');
                card.className = 'splash-card';
                card.innerHTML = `
                    <img src="${splash.image.url}" alt="${splash.title || ''}">
                    <div class="info" style="padding: 15px;">
                        <strong style="display: block; margin-bottom: 5px;">${splash.title || 'No Title'}</strong>
                        <p style="font-size:0.9em; color:#777; margin: 0;">Type: ${splash.type}</p>
                    </div>
                    <button class="delete-btn" onclick="handleDeleteSplash('${splash._id}')" title="Delete">‚úï</button>
                `;
                splashGrid.appendChild(card);
            });
        };

        // ==================================================
        // === BANNER MANAGER FUNCTIONS ===
        // ==================================================
        const resetBannerForm = () => {
            bannerUploadForm.reset();
            editBannerIdInput.value = '';
            bannerFormTitle.textContent = 'Upload New Banner';
            bannerSubmitBtn.textContent = 'Upload Banner';
            bannerCancelEditBtn.classList.add('hidden');
            bannerUploadError.classList.add('hidden');
            mediaBannerInput.required = true;
            mediaBannerLabel.textContent = 'Banner Image File (Required)';
            editImageHint.style.display = 'none';
            bannerActiveSelect.value = 'true';
            bannerPositionSelect.value = 'top';
        };

        window.handleEditBannerBtnClick = (bannerDataString) => {
            const banner = JSON.parse(decodeURIComponent(bannerDataString));
            editBannerIdInput.value = banner._id;
            bannerTitleInput.value = banner.title || '';
            bannerPositionSelect.value = banner.position || 'top'; 
            bannerActiveSelect.value = banner.isActive ? 'true' : 'false';
            if(banner.section) {
                document.getElementById('banner-section').value = banner.section;
            }
            
            bannerFormTitle.textContent = 'Edit Banner';
            bannerSubmitBtn.textContent = 'Update Banner';
            bannerCancelEditBtn.classList.remove('hidden');
            bannerUploadError.classList.add('hidden');
            mediaBannerInput.required = false;
            mediaBannerLabel.textContent = 'Change Banner Image (Optional)';
            editImageHint.style.display = 'block';
            document.getElementById('banner-form-card').scrollIntoView({ behavior: 'smooth' });
        };

        const fetchBanners = async () => {
            const token = localStorage.getItem('admin_token');
            if (!token) return handleLogout();
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/banners`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401) return handleLogout();
                const banners = await response.json();
                renderBanners(banners);
            } catch (error) { console.error('Error fetching banners:', error); }
        };

        const handleBannerUpload = async (e) => {
            e.preventDefault();
            bannerUploadError.classList.add('hidden');
            const token = localStorage.getItem('admin_token');
            const bannerId = editBannerIdInput.value;
            const isEditMode = !!bannerId;
            const formData = new FormData();
            const mediaFile = mediaBannerInput.files[0];
            const title = bannerTitleInput.value;
            const position = bannerPositionSelect.value;
            const isActive = bannerActiveSelect.value;
            const section = document.getElementById('banner-section').value;

            if (!isEditMode && !mediaFile) {
                bannerUploadError.textContent = "Please select an image file for a new banner.";
                bannerUploadError.classList.remove('hidden');
                return;
            }
            if (mediaFile) formData.append('media', mediaFile);
            formData.append('title', title || ''); 
            formData.append('link', title || ''); 
            formData.append('position', position); 
            formData.append('isActive', isActive);
            formData.append('section', section);
            formData.append('type', 'image');

            try {
                let url = `${API_BASE_URL}/api/admin/banners`;
                let method = 'POST';
                if (isEditMode) {
                      url = `${API_BASE_URL}/api/admin/banners/${bannerId}`;
                      method = 'PUT';
                }
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Operation failed.');
                resetBannerForm();
                fetchBanners();
                if(isEditMode) alert("Banner updated successfully!");
            } catch (error) {
                bannerUploadError.textContent = error.message;
                bannerUploadError.classList.remove('hidden');
            }
        };

        const handleDeleteBanner = async (id) => {
            if (!confirm('Delete this banner?')) return;
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/banners/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to delete.');
                if(editBannerIdInput.value === id) resetBannerForm();
                fetchBanners();
            } catch (error) { alert(error.message); }
        };

        const renderBanners = (banners) => {
            bannerGrid.innerHTML = '';
            if (!banners || banners.length === 0) {
                bannerGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #777;">No banners found.</p>';
                return;
            }
            banners.forEach(banner => {
                const card = document.createElement('div');
                card.className = 'splash-card'; 
                const statusColor = banner.isActive ? 'var(--success-color)' : '#ccc';
                card.style.borderBottom = `4px solid ${statusColor}`;
                const bannerDataSafe = encodeURIComponent(JSON.stringify(banner));

                card.innerHTML = `
                    <img src="${banner.image?.url || ''}" alt="${banner.title || 'Banner'}" style="height: 120px;">
                    <div class="info" style="padding: 15px;">
                        <strong style="display:block; margin-bottom:5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${banner.title || 'No Title'}</strong>
                        <div style="font-size:0.85em; color:#666;">
                            <span style="text-transform: capitalize; font-weight: 500;">${banner.position || 'Hero'}</span>
                            | <span style="text-transform: capitalize; font-weight: 500; color: #3b82f6;">${banner.section || 'Home'}</span>
                            | <span style="color: ${banner.isActive ? 'var(--success-color)':'#999'}">${banner.isActive ? 'Active' : 'Inactive'}</span>
                        </div>
                    </div>
                    <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 8px;">
                        <button class="btn btn-info" style="padding: 6px 12px; font-size: 0.8rem; margin:0; background:white; color: var(--info-color); border: 1px solid var(--info-color);" onclick="handleEditBannerBtnClick('${bannerDataSafe}')">Edit</button>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem; margin:0;" onclick="handleDeleteBanner('${banner._id}')">‚úï</button>
                    </div>
                `;
                bannerGrid.appendChild(card);
            });
        };

        // ==========================================
        // --- Coupon Manager Functions ---
        // ==========================================
        const fetchCoupons = async () => {
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/coupons`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401) return handleLogout();
                const coupons = await response.json();
                renderCoupons(coupons);
            } catch (error) { console.error('Error fetching coupons:', error); }
        };

        const renderCoupons = (coupons) => {
            couponList.innerHTML = '';
            if (!coupons || coupons.length === 0) {
                couponList.innerHTML = '<p style="padding: 20px; color: #666;">No active coupons found.</p>';
                return;
            }
            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>Code</th><th>Type</th><th>Value</th><th>Min Purchase</th><th>Expires</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            coupons.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span style="background: #F3F4F6; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-weight: 700;">${c.code}</span></td>
                    <td style="text-transform: capitalize;">${c.discountType}</td>
                    <td style="font-weight: 600; color: var(--success-color);">${c.discountType === 'percentage' ? `${c.discountValue}%` : `‚Çπ${c.discountValue}`}</td>
                    <td>‚Çπ${c.minPurchaseAmount || 0}</td>
                    <td>${new Date(c.expiryDate).toLocaleDateString()}</td>
                    <td>${c.isActive ? '<span class="status-badge status-active">Active</span>' : '<span class="status-badge status-inactive">Inactive</span>'}</td>
                    <td><button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.75rem;" onclick="handleDeleteCoupon('${c._id}')">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
            couponList.appendChild(table);
        };
        
        const handleCouponCreate = async (e) => {
            e.preventDefault();
            couponError.classList.add('hidden');
            const token = localStorage.getItem('admin_token');
            const data = Object.fromEntries(new FormData(couponForm).entries());
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/coupons`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to create.');
                couponForm.reset();
                fetchCoupons();
            } catch (error) {
                couponError.textContent = error.message;
                couponError.classList.remove('hidden');
            }
        };

        const handleDeleteCoupon = async (id) => {
            if (!confirm('Delete this coupon?')) return;
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/coupons/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to delete.');
                fetchCoupons();
            } catch (error) { alert(error.message); }
        };

        // ==========================================
        // --- Notification Functions ---
        // ==========================================
        window.toggleScheduleInput = (show) => {
            const container = document.getElementById('schedule-container');
            const input = document.getElementById('scheduledAt');
            if (show) {
                container.classList.remove('hidden');
                input.required = true;
            } else {
                container.classList.add('hidden');
                input.value = ''; 
                input.required = false;
            }
        }

        const handleNotificationSend = async (e) => {
            e.preventDefault();
            notificationStatus.className = 'hidden';
            const token = localStorage.getItem('admin_token');
            const formData = new FormData(notificationForm);
            const scheduledAt = formData.get('scheduledAt');

            if (!formData.get('title') || !formData.get('message')) {
                notificationStatus.textContent = 'Title and Message are required.';
                notificationStatus.className = 'error-message';
                return;
            }

            try {
                let response;
                if (scheduledAt) {
                    formData.append('body', formData.get('message'));
                    response = await fetch(`${API_BASE_URL}/api/admin/notifications/schedule`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                } else {
                    response = await fetch(`${API_BASE_URL}/api/admin/broadcast`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                }
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to send.');
                notificationStatus.textContent = scheduledAt ? 'Notification Scheduled.' : 'Notification Sent.';
                notificationStatus.className = 'success-message';
                notificationForm.reset();
                toggleScheduleInput(false);
                document.querySelector('input[value="now"]').checked = true;
            } catch (error) {
                notificationStatus.textContent = error.message;
                notificationStatus.className = 'error-message';
            }
        };
        
        // ==========================================
        // --- Customer Returns Functions ---
        // ==========================================
        const fetchReturnRequests = async () => {
            const token = localStorage.getItem('admin_token');
            if (!token) return handleLogout();
            returnsTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Loading...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/orders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401) return handleLogout();
                const orders = await response.json();
                
                const pendingReturns = orders.filter(o => 
                    o.deliveryStatus === 'Return Requested' || 
                    o.deliveryStatus === 'Return Accepted by Admin'
                );
                renderReturnRequests(pendingReturns);
            } catch (error) { 
                console.error('Error:', error);
                returnsTableBody.innerHTML = '<tr><td colspan="8" class="error-message" style="text-align:center;">Error fetching requests.</td></tr>';
            }
        };

        const renderReturnRequests = (orders) => {
            returnsTableBody.innerHTML = '';
            if (!orders || orders.length === 0) {
                returnsTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 30px; color: #777;">No pending return requests.</td></tr>';
                return;
            }
            orders.forEach(order => {
                const grandTotal = (order.totalAmount + (order.shippingFee || 0) + (order.taxAmount || 0)) - (order.discountAmount || 0);
                const refundRequest = order.refunds ? order.refunds.findLast(r => ['requested', 'pending', 'approved'].includes(r.status)) : null;
                const customerName = order.user?.name || 'N/A';
                
                let sellerName = 'Admin/Multi';
                if(order.items && order.items.length > 0 && order.items[0].product && order.items[0].product.seller) {
                    sellerName = order.items[0].product.seller.name || 'Unknown Seller';
                }

                let paymentDisplay = '<span style="color:#999">Not Provided</span>';
                if (refundRequest) {
                    if (refundRequest.upiId) {
                        paymentDisplay = `<strong style="color:var(--upi-color)">UPI:</strong> ${refundRequest.upiId}`;
                    } else if (refundRequest.bankAccountNumber) {
                            paymentDisplay = `<div style="font-size:0.9em;"><strong>Bank:</strong> ${refundRequest.bankAccountNumber}<br><strong>IFSC:</strong> ${refundRequest.ifsc}</div>`;
                    }
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-family:monospace; font-weight:700; color: var(--primary-dark);">#${order._id.slice(-6)}</td>
                    <td><div style="font-weight:500;">${customerName}</div></td>
                    <td style="color: #E65100; font-weight:500;">${sellerName}</td> 
                    <td style="font-weight:700;">‚Çπ${grandTotal.toFixed(2)}</td>
                    <td style="max-width: 150px; overflow:hidden; text-overflow:ellipsis;">${refundRequest ? refundRequest.reason : 'N/A'}</td>
                    <td>${paymentDisplay}</td> 
                    <td><span class="status-badge status-requested">${order.deliveryStatus}</span></td>
                    <td>
                        <button 
                            class="btn btn-info" 
                            style="padding: 6px 12px; font-size: 0.8rem;"
                            onclick="openApproveReturnModal('${order._id}')"
                            ${order.deliveryStatus !== 'Return Requested' ? 'disabled style="opacity:0.6; cursor:not-allowed;"' : ''}>
                            Review & Approve
                        </button>
                    </td>
                `;
                returnsTableBody.appendChild(tr);
            });
        };

        // ==========================================
        // --- Seller Settlement Functions ---
        // ==========================================
        const fetchSettlements = async () => {
            const token = localStorage.getItem('admin_token');
            if (!token) return handleLogout();
            settlementsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Loading settlements...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/payouts/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 404) {
                      settlementsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Endpoint /api/admin/payouts/pending not found.</td></tr>';
                      return;
                }
                
                const requests = await response.json();
                renderSettlements(requests);
            } catch (error) {
                console.error('Error fetching settlements:', error);
                settlementsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No active settlement requests found.</td></tr>';
            }
        };

        const renderSettlements = (requests) => {
            settlementsTableBody.innerHTML = '';
            if (!requests || requests.length === 0) {
                settlementsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 30px; color: #777;">No pending payout requests.</td></tr>';
                return;
            }

            requests.forEach(req => {
                const statusClass = 'status-pending';
                const displayStatus = req.status;
                
                let notes = req.notes || 'No details provided';
                
                if (notes.includes("VPA:")) {
                    notes = notes.replace('MANUAL TRANSFER:', '').trim();
                    notes = notes.replace(/(VPA:)(.*)/, '$1 <strong style="color: var(--upi-color); font-size: 1.1em;">$2</strong>');
                } else {
                    notes = notes.replace('MANUAL TRANSFER:', '').trim();
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-family:monospace; font-weight: 700;">#${req._id.slice(-6)}</td>
                    <td>
                        <strong>${req.seller?.name || 'Unknown'}</strong><br>
                        <span style="font-size:0.85em; color:#666;">${req.seller?.phone || 'N/A'}</span>
                    </td>
                    <td style="font-weight:700; color: var(--primary-dark); font-size: 1.1rem;">‚Çπ${req.amount}</td>
                    <td style="font-size:0.9em; max-width: 280px; line-height: 1.5;">${notes}</td>
                    <td>${new Date(req.createdAt).toLocaleDateString()}</td>
                    <td><span class="status-badge ${statusClass}" style="text-transform:capitalize;">${displayStatus}</span></td>
                    <td>
                        <button class="btn btn-success" style="padding: 6px 12px; font-size: 0.8rem;" onclick="handleSettlementAction('${req._id}')">Settle Payment</button>
                    </td>
                `;
                settlementsTableBody.appendChild(tr);
            });
        };

        window.handleSettlementAction = async (id) => {
            const token = localStorage.getItem('admin_token');
            
            const transactionId = prompt("Please make the payment manually via UPI or Bank Transfer.\n\nEnter the Transaction ID (UTR) here to confirm:");
            
            if (transactionId === null) return; 
            if (transactionId.trim() === "") {
                alert("Transaction ID is required to mark the payout as Settled.");
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/payouts/${id}/process`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ transactionId: transactionId, notes: "Manual Settlement via Admin Panel" })
                });
                
                if(!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Action failed');
                }
                
                alert("Payment marked as Settled successfully!");
                fetchSettlements(); 
            } catch(e) {
                alert(e.message);
            }
        };

        // ==========================================
        // --- Delivery Boys Functions ---
        // ==========================================
        const fetchDeliveryBoys = async () => {
            const token = localStorage.getItem('admin_token');
            if (!token) return handleLogout();
            deliveryTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">Loading...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/delivery-boys`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401) return handleLogout();
                const deliveryBoysData = await response.json();
                renderDeliveryBoys(deliveryBoysData);
            } catch (error) { 
                deliveryTableBody.innerHTML = '<tr><td colspan="5" class="error-message" style="text-align:center;">Error fetching delivery boys.</td></tr>';
            }
        };

        const renderDeliveryBoys = (boys) => {
            deliveryTableBody.innerHTML = '';
            if (!boys || boys.length === 0) {
                deliveryTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 30px; color: #777;">No delivery boys registered.</td></tr>';
                return;
            }
            boys.forEach(boy => {
                const tr = document.createElement('tr');
                const isAvailable = boy.role === 'delivery' && boy.approved === true; 
                const statusStyle = isAvailable ? 'status-active' : 'status-inactive';
                const statusText = isAvailable ? 'Active' : 'Inactive/Pending';
                const pincodesList = boy.pincodes && boy.pincodes.length > 0 ? boy.pincodes.join(', ') : '<span style="color:#999">None assigned</span>';

                tr.innerHTML = `
                    <td>
                        <strong>${boy.name || 'N/A'}</strong>
                    </td>
                    <td>${boy.phone || 'N/A'}</td>
                    <td>${pincodesList}</td>
                    <td><span class="status-badge ${statusStyle}">${statusText}</span></td>
                    <td><button class="btn btn-warning" style="padding: 6px 12px; font-size: 0.8rem; background-color: #F59E0B; border-color: #F59E0B;" onclick="alert('Go to the main Admin Users/Sellers tab to manage approvals.')">Manage</button></td>
                `;
                deliveryTableBody.appendChild(tr);
            });
        };

        // ==========================================
        // --- üöñ DRIVER MONITORING LOGIC ---
        // ==========================================
        const fetchDriversStatus = async () => {
            const token = localStorage.getItem('admin_token');
            driversTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Loading drivers status...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/drivers-status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load drivers');
                
                const drivers = await response.json();
                renderDrivers(drivers);
            } catch (err) {
                console.error(err);
                driversTableBody.innerHTML = '<tr><td colspan="7" class="error-message" style="text-align:center;">Error fetching driver data.</td></tr>';
            }
        };

        const renderDrivers = (drivers) => {
            driversTableBody.innerHTML = '';
            if (!drivers || drivers.length === 0) {
                driversTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 30px;">No drivers found.</td></tr>';
                return;
            }

            drivers.forEach(driver => {
                const tr = document.createElement('tr');
                const isOnline = driver.status.includes('Online');
                const statusColor = isOnline ? 'color: var(--success-color);' : 'color: #999;';
                const isLocked = driver.locked.includes('Locked');
                
                tr.innerHTML = `
                    <td style="font-weight: 500;">${driver.name}</td>
                    <td>${driver.vehicle || 'Unknown'}</td>
                    <td>${driver.phone}</td>
                    <td style="${statusColor} font-weight: bold;">${driver.status}</td>
                    <td style="font-family: monospace;">${driver.balance}</td>
                    <td>
                        <span class="status-badge ${isLocked ? 'status-rejected' : 'status-active'}">
                            ${driver.locked}
                        </span>
                    </td>
                    <td style="display: flex; gap: 5px;">
                        <button class="btn ${isLocked ? 'btn-success' : 'btn-warning'}" 
                                style="padding: 6px 12px; font-size: 0.8rem;" 
                                onclick="openBlockMapModal('${driver.id}', '${driver.location || 'Unknown'}', ${isLocked})">
                            ${isLocked ? 'Unlock' : 'Block'}
                        </button>
                        <button class="btn btn-danger" 
                                style="padding: 6px 12px; font-size: 0.8rem;" 
                                onclick="punishDriver('${driver.id}')">
                            üëÆ Punish
                        </button>
                    </td>
                `;
                driversTableBody.appendChild(tr);
            });
        };

        // --- Driver Block Map Modal Logic ---
        const openBlockMapModal = (driverId, locationStr, isCurrentlyLocked) => {
            targetDriverId = driverId;
            targetDriverAction = isCurrentlyLocked ? 'unblock' : 'block';
            
            const confirmBtn = document.getElementById('confirm-block-driver-btn');
            confirmBtn.innerText = isCurrentlyLocked ? 'Confirm Unlock' : 'Confirm Block';
            confirmBtn.className = isCurrentlyLocked ? 'btn btn-success' : 'btn btn-danger';

            // Setup Map Link
            const mapLink = document.getElementById('driver-map-link');
            if(locationStr === 'Unknown' || !locationStr.includes(',')) {
                mapLink.href = '#';
                mapLink.innerText = 'Location Unavailable';
                mapLink.style.pointerEvents = 'none';
                mapLink.style.opacity = '0.5';
            } else {
                const parts = locationStr.split(',').map(s => s.trim());
                mapLink.href = `http://googleusercontent.com/maps.google.com/5{parts[0]},${parts[1]}`;
                mapLink.innerText = 'üìç View Location on Google Maps';
                mapLink.style.pointerEvents = 'auto';
                mapLink.style.opacity = '1';
            }

            driverMapModal.style.display = 'flex';
        };

        const closeBlockDriverModal = () => {
            driverMapModal.style.display = 'none';
            targetDriverId = null;
        };

        document.getElementById('confirm-block-driver-btn').addEventListener('click', async () => {
            if(!targetDriverId || !targetDriverAction) return;

            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/drivers/${targetDriverId}/block`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ action: targetDriverAction })
                });

                if(!response.ok) throw new Error('Action failed');
                
                alert(`Driver ${targetDriverAction}ed successfully.`);
                closeBlockDriverModal();
                fetchDriversStatus(); 
            } catch(err) {
                alert(err.message);
            }
        });

        const punishDriver = async (driverId) => {
            const actionType = prompt(
                "Enter punishment type:\n\nType 'temp' for 48-Hour Ban\nType 'perm' for Permanent Ban"
            );

            if (actionType !== 'temp' && actionType !== 'perm') return;

            const reason = prompt("Enter Reason for punishment:");
            if(!reason) return alert("Reason is required!");

            const apiAction = actionType === 'temp' ? 'temp_ban' : 'perm_ban';
            const token = localStorage.getItem('admin_token');

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/drivers/${driverId}/punish`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ action: apiAction, reason: reason })
                });

                if(!response.ok) throw new Error('Punishment failed');
                
                alert(`Driver punished successfully: ${apiAction}`);
                fetchDriversStatus();
            } catch(err) {
                alert(err.message);
            }
        };

        // ==========================================
        // --- üö® SOS ALERT LOGIC ---
        // ==========================================
        const fetchSOSAlerts = async () => {
            const token = localStorage.getItem('admin_token');
            sosTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Scanning for alerts...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/complaints`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load alerts');
                
                const allComplaints = await response.json();
                const sosAlerts = allComplaints.filter(c => 
                    c.reason && (c.reason.toLowerCase().includes('sos') || c.reason.toLowerCase().includes('emergency'))
                );
                
                renderSOSAlerts(sosAlerts);
            } catch (err) {
                console.error(err);
                sosTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: red;">Error loading SOS alerts.</td></tr>';
            }
        };

        const renderSOSAlerts = (alerts) => {
            sosTableBody.innerHTML = '';
            if (!alerts || alerts.length === 0) {
                sosTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 30px; color: #22c55e;">‚úÖ No active SOS alerts. Safe!</td></tr>';
                return;
            }

            alerts.forEach(alert => {
                const tr = document.createElement('tr');
                tr.classList.add('sos-row'); 
                
                const mapLink = alert.ride ? `http://googleusercontent.com/maps.google.com/6{alert.ride.dropLocation?.coordinates[1]},${alert.ride.dropLocation?.coordinates[0]}` : '#';

                tr.innerHTML = `
                    <td><span class="status-badge status-emergency">üö® SOS</span></td>
                    <td style="font-weight:bold;">${alert.user?.name || 'Unknown'}</td>
                    <td>${alert.user?.phone || 'N/A'}</td>
                    <td><a href="${mapLink}" target="_blank" style="color:#DC2626; font-weight:bold; text-decoration:underline;">View on Map üìç</a></td>
                    <td>${new Date(alert.createdAt).toLocaleTimeString()}</td>
                    <td>${alert.status}</td>
                    <td>
                        <button class="btn btn-success" style="padding: 6px 12px; font-size: 0.8rem;" onclick="resolveSOS('${alert._id}')">Resolve</button>
                    </td>
                `;
                sosTableBody.appendChild(tr);
            });
        };

        const resolveSOS = async (id) => {
            if(!confirm("Mark this SOS alert as Resolved?")) return;
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/complaints/${id}/resolve`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ status: 'Resolved', adminNote: 'Handled via SOS Panel' })
                });
                if(!response.ok) throw new Error('Failed');
                fetchSOSAlerts();
            } catch(e) { alert(e.message); }
        };

        // ==========================================
        // --- Affiliate Marketing Functions ---
        // ==========================================
        const affiliateForm = document.getElementById('affiliate-form');
        const affiliateListContainer = document.getElementById('affiliate-list-container');
        const affError = document.getElementById('affiliate-error');
        const affSubmitBtn = document.getElementById('aff-submit-btn');
        const affCancelBtn = document.getElementById('aff-cancel-btn');
        const editAffIdInput = document.getElementById('edit-affiliate-id');

        const fetchAffiliateProducts = async () => {
            const token = localStorage.getItem('admin_token');
            if (!token) return handleLogout();
            
            affiliateListContainer.innerHTML = '<p>Loading...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/affiliate-products`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const products = await response.json();
                renderAffiliateProducts(products);
            } catch (error) {
                console.error('Error fetching affiliate products:', error);
                affiliateListContainer.innerHTML = '<p class="error-message">Failed to load products.</p>';
            }
        };

        const renderAffiliateProducts = (products) => {
            affiliateListContainer.innerHTML = '';
            if (!products || products.length === 0) {
                affiliateListContainer.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#777;">No affiliate products found.</p>';
                return;
            }

            products.forEach(prod => {
                const card = document.createElement('div');
                card.className = 'splash-card';
                const statusColor = prod.isActive ? 'var(--success-color)' : '#ccc';
                card.style.borderBottom = `4px solid ${statusColor}`;
                
                const prodDataSafe = encodeURIComponent(JSON.stringify(prod));

                card.innerHTML = `
                    <img src="${prod.image?.url || ''}" alt="${prod.name}" style="height: 140px; object-fit: contain; padding: 10px;">
                    <div class="info" style="padding: 15px;">
                        <div style="font-size: 0.8em; color: #666; text-transform: uppercase; letter-spacing: 1px;">${prod.platform}</div>
                        <strong style="display:block; margin: 5px 0; font-size: 1.1em;">${prod.name}</strong>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color: var(--primary-dark); font-weight: bold;">‚Çπ${prod.price}</span>
                            <span style="font-size: 0.85em; background: #eff6ff; padding: 2px 6px; border-radius: 4px;">üñ±Ô∏è ${prod.clicks || 0} Clicks</span>
                        </div>
                    </div>
                    <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 5px;">
                        <button class="btn btn-info" style="padding: 5px 10px; font-size: 0.75rem;" onclick="handleEditAffiliate('${prodDataSafe}')">Edit</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.75rem;" onclick="handleDeleteAffiliate('${prod._id}')">‚úï</button>
                    </div>
                    <a href="${prod.affiliateLink}" target="_blank" style="display:block; text-align:center; background:#f9fafb; padding:8px; font-size:0.85rem; text-decoration:none; color:var(--primary-color); border-top:1px solid #eee;">Check Link ‚Üó</a>
                `;
                affiliateListContainer.appendChild(card);
            });
        };

        affiliateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            affError.classList.add('hidden');
            const token = localStorage.getItem('admin_token');
            const formData = new FormData(affiliateForm);
            
            const isActiveVal = document.getElementById('aff-active').value;
            formData.set('isActive', isActiveVal); 

            const id = editAffIdInput.value;
            const isEdit = !!id;

            try {
                let url = `${API_BASE_URL}/api/admin/affiliate-products`;
                let method = 'POST';

                if (isEdit) {
                    url = `${API_BASE_URL}/api/admin/affiliate-products/${id}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Operation failed');

                alert(isEdit ? 'Product Updated!' : 'Product Added!');
                resetAffiliateForm();
                fetchAffiliateProducts();

            } catch (error) {
                affError.textContent = error.message;
                affError.classList.remove('hidden');
            }
        });

        window.handleEditAffiliate = (prodDataString) => {
            const prod = JSON.parse(decodeURIComponent(prodDataString));
            editAffIdInput.value = prod._id;
            
            document.getElementById('aff-name').value = prod.name;
            document.getElementById('aff-platform').value = prod.platform;
            document.getElementById('aff-link').value = prod.affiliateLink;
            document.getElementById('aff-price').value = prod.price;
            document.getElementById('aff-mrp').value = prod.originalPrice || '';
            document.getElementById('aff-desc').value = prod.description || '';
            document.getElementById('aff-active').value = prod.isActive ? 'true' : 'false';

            document.getElementById('aff-image').required = false;
            document.getElementById('aff-img-hint').style.display = 'block';
            document.getElementById('aff-form-title').textContent = 'Edit Affiliate Product';
            affSubmitBtn.textContent = 'Update Product';
            affCancelBtn.classList.remove('hidden');

            affiliateForm.scrollIntoView({ behavior: 'smooth' });
        };

        window.handleDeleteAffiliate = async (id) => {
            if(!confirm('Are you sure you want to delete this product?')) return;
            const token = localStorage.getItem('admin_token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/affiliate-products/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if(!response.ok) throw new Error('Delete failed');
                
                if(editAffIdInput.value === id) resetAffiliateForm();
                fetchAffiliateProducts();
                
            } catch (error) {
                alert(error.message);
            }
        };

        const resetAffiliateForm = () => {
            affiliateForm.reset();
            editAffIdInput.value = '';
            document.getElementById('aff-form-title').textContent = 'Add Affiliate Product';
            affSubmitBtn.textContent = 'Add Product';
            affCancelBtn.classList.add('hidden');
            document.getElementById('aff-image').required = false; 
            document.getElementById('aff-img-hint').style.display = 'none';
        };

        affCancelBtn.addEventListener('click', resetAffiliateForm);

        // ==========================================
        // --- Modal Functions (Returns) ---
        // ==========================================
        const openApproveReturnModal = (orderId) => {
            currentOrderId = orderId;
            modalError.classList.add('hidden');
            assignDeliveryModal.style.display = 'flex';
        };
        const closeApproveReturnModal = () => {
            assignDeliveryModal.style.display = 'none';
            currentOrderId = null;
        };
        const handleApproveReturn = async () => {
            modalError.classList.add('hidden');
            if (!currentOrderId) return;
            const token = localStorage.getItem('admin_token');
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/orders/${currentOrderId}/approve-return`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    }
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to approve return.');
                alert('‚úÖ Return Approved! Pickup job created.');
                closeApproveReturnModal();
                fetchReturnRequests();
            } catch (error) {
                modalError.textContent = error.message;
                modalError.classList.remove('hidden');
            }
        };

        // ==========================================
        // --- Initialization & Event Listeners ---
        // ==========================================
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        menuToggle.addEventListener('click', toggleSidebar);
        
        uploadForm.addEventListener('submit', handleUpload);
        window.handleDeleteSplash = handleDeleteSplash;

        bannerUploadForm.addEventListener('submit', handleBannerUpload);
        bannerCancelEditBtn.addEventListener('click', resetBannerForm);
        window.handleDeleteBanner = handleDeleteBanner;
        
        couponForm.addEventListener('submit', handleCouponCreate);
        notificationForm.addEventListener('submit', handleNotificationSend);
        confirmApprovalBtn.addEventListener('click', handleApproveReturn);
        closeModalBtn.addEventListener('click', closeApproveReturnModal);
        
        window.onclick = (event) => { 
            if (event.target === assignDeliveryModal) closeApproveReturnModal();
            if (event.target === driverMapModal) closeBlockDriverModal();
            if (event.target === document.getElementById('zone-map-modal')) closeZoneMapModal();
        };
        
        window.handleDeleteCoupon = handleDeleteCoupon;
        window.openApproveReturnModal = openApproveReturnModal;

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('admin_token')) {
                showDashboard();
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
