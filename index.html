<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Sauda - Master Admin</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- Modern CSS Variables --- */
        :root {
            --primary: #4F46E5; /* Indigo */
            --primary-hover: #4338ca;
            --primary-light: #EEF2FF;
            
            --bg: #F1F5F9; /* Slate 100 */
            --surface: #FFFFFF;
            --border: #E2E8F0;
            
            --text-main: #0F172A;
            --text-muted: #64748B;
            
            --success: #10B981; --success-bg: #D1FAE5;
            --danger: #EF4444; --danger-bg: #FEE2E2;
            --warning: #F59E0B; --warning-bg: #FEF3C7;
            --info: #3B82F6; --info-bg: #DBEAFE;
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-font-smoothing: antialiased; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text-main); font-size: 14px; }

        /* --- Layout --- */
        #app-container { display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { 
            width: 270px; background: var(--surface); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 50; flex-shrink: 0; 
        }
        .sidebar-header { 
            padding: 25px; display: flex; align-items: center; gap: 12px; 
            border-bottom: 1px solid var(--border); 
        }
        .brand-icon { width: 32px; height: 32px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; }
        .brand-text { font-size: 1.25rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }

        .sidebar-nav { flex: 1; overflow-y: auto; padding: 20px 15px; }
        .nav-category { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin: 15px 10px 5px; letter-spacing: 0.5px; }
        
        .nav-link { 
            display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
            color: var(--text-muted); text-decoration: none; font-weight: 500; 
            border-radius: 10px; transition: all 0.2s; margin-bottom: 2px;
        }
        .nav-link:hover { background: var(--bg); color: var(--primary); }
        .nav-link.active { background: var(--primary-light); color: var(--primary); font-weight: 700; }
        .nav-link i { width: 20px; text-align: center; }

        /* SOS Alert Style */
        .nav-link[data-tab="sos"] { color: var(--danger); background: #fff5f5; border: 1px dashed var(--danger); margin-top: 10px; }
        .nav-link[data-tab="sos"].active { background: var(--danger); color: white; border-style: solid; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }

        /* Main Content */
        #main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--text-main); }
        .user-profile { display: flex; align-items: center; gap: 10px; background: var(--surface); padding: 8px 16px; border-radius: 50px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .avatar { width: 32px; height: 32px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }

        /* --- Components --- */
        .card { background: var(--surface); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 25px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .card-header h3 { margin: 0; font-size: 1.1rem; font-weight: 700; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: var(--success); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-dark { background: var(--text-main); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        /* Inputs */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: var(--text-muted); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: #f8fafc; font-size: 0.95rem; transition: 0.2s; color: var(--text-main); }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px var(--primary-light); }
        .form-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .form-row > div { flex: 1; min-width: 200px; }

        /* Tables */
        .table-responsive { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; background: var(--surface); }
        th { text-align: left; padding: 15px; background: #f8fafc; color: var(--text-muted); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; }

        /* --- PRODUCT APPROVAL GRID (Redesigned) --- */
        .approval-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding-bottom: 80px; }
        
        .approval-card { 
            background: var(--surface); border-radius: var(--radius); overflow: hidden; 
            border: 1px solid var(--border); box-shadow: var(--shadow); 
            display: flex; flex-direction: column; transition: all 0.3s ease; position: relative; 
        }
        .approval-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); border-color: var(--primary-light); }
        
        /* Badges */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
        .status-badge.pending { background: var(--warning-bg); color: #B45309; }
        .status-badge.active { background: var(--success-bg); color: #065F46; }
        .status-badge.rejected { background: var(--danger-bg); color: #991B1B; }

        .card-checkbox { position: absolute; top: 15px; left: 15px; width: 20px; height: 20px; z-index: 10; cursor: pointer; accent-color: var(--primary); }
        .card-badge-float { position: absolute; top: 15px; right: 15px; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .approval-img-wrapper { position: relative; height: 180px; width: 100%; background: #f1f5f9; cursor: pointer; overflow: hidden; }
        .approval-img-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .approval-card:hover .approval-img-wrapper img { transform: scale(1.05); }
        
        .approval-info-btn { 
            position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.95); 
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 1rem; color: var(--text-main); cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: 0.2s;
        }
        .approval-info-btn:hover { transform: scale(1.1); color: var(--primary); }

        .card-body { padding: 15px; flex-grow: 1; }
        .card-title { font-weight: 700; font-size: 1rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main); }
        .card-meta { font-size: 0.85rem; color: var(--text-muted); display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-price { font-size: 1.25rem; font-weight: 800; color: var(--primary); }

        .card-actions { display: flex; border-top: 1px solid var(--border); }
        .card-action-btn { flex: 1; padding: 12px; border: none; background: white; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-card-reject { color: var(--danger); border-right: 1px solid var(--border); }
        .btn-card-reject:hover { background: #fef2f2; }
        .btn-card-approve { color: var(--success); }
        .btn-card-approve:hover { background: #ecfdf5; }

        /* Animation States */
        .card-approved-state { border: 2px solid var(--success); background: #ecfdf5; }
        .approved-overlay { display: flex; align-items: center; justify-content: center; height: 45px; background: var(--success); color: white; font-weight: 700; letter-spacing: 0.5px; }

        /* Floating Bulk Bar */
        .bulk-bar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); 
            background: #1e293b; color: white; padding: 12px 25px; border-radius: 50px; 
            display: flex; align-items: center; gap: 20px; z-index: 100; transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            opacity: 0; box-shadow: 0 20px 40px rgba(0,0,0,0.3); pointer-events: none;
        }
        .bulk-bar.visible { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: all; }
        .bulk-count { font-weight: 700; color: #fbbf24; }

        /* --- Modals (Glassmorphism) --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal-content { background: var(--surface); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 20px; animation: modalPop 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        @keyframes modalPop { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .close-btn { float: right; font-size: 1.5rem; border: none; background: none; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .close-btn:hover { color: var(--danger); transform: rotate(90deg); }

        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #312E81 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #login-box { background: white; padding: 50px; border-radius: 24px; width: 100%; max-width: 420px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); text-align: center; }

        /* General Grids */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .simple-card { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; position: relative; background: white; transition: 0.2s; }
        .simple-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
        .simple-card img { width: 100%; height: 140px; object-fit: cover; }
        .simple-info { padding: 12px; }
        .btn-icon-del { position: absolute; top: 8px; right: 8px; background: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: var(--danger); box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .btn-icon-del:hover { background: var(--danger); color: white; }

        .hidden { display: none !important; }
        
        /* Mobile */
        .menu-toggle { display: none; position: absolute; top: 20px; left: 20px; z-index: 60; background: var(--surface); border: 1px solid var(--border); padding: 8px 12px; font-size: 1.2rem; border-radius: 8px; box-shadow: var(--shadow); cursor: pointer; }
        @media (max-width: 768px) {
            #sidebar { position: fixed; height: 100%; transform: translateX(-100%); box-shadow: 20px 0 50px rgba(0,0,0,0.1); }
            #sidebar.open { transform: translateX(0); }
            .menu-toggle { display: block; }
            .bulk-bar { width: 90%; flex-direction: column; gap: 10px; border-radius: 16px; padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div id="login-box">
            <div style="width: 60px; height: 60px; background: var(--primary-light); color: var(--primary); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 0 auto 20px;"><i class="fa-solid fa-lock"></i></div>
            <h2 style="color: var(--text-main); margin-bottom: 5px;">Welcome Back</h2>
            <p style="color: var(--text-muted); margin-bottom: 25px;">Sign in to manage Quick Sauda</p>
            <form id="login-form">
                <div id="login-msg" style="color: var(--danger); margin-bottom: 15px; background: #FEF2F2; padding: 10px; border-radius: 8px; font-size: 0.9rem;" class="hidden"></div>
                <div class="form-group" style="text-align: left;">
                    <label>Email Address</label>
                    <input type="email" id="email" placeholder="admin@quicksauda.com" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 1rem;">Sign In</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        
        <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">
            <i class="fa-solid fa-bars"></i>
        </button>

        <div id="sidebar">
            <div class="sidebar-header">
                <div class="brand-icon">Q</div>
                <span class="brand-text">Quick Sauda</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-category">Main</div>
                <a class="nav-link active" data-tab="categories"><i class="fa-solid fa-layer-group"></i> Categories</a>
                <a class="nav-link" data-tab="approvals"><i class="fa-solid fa-check-to-slot" style="color: #F59E0B;"></i> Approvals</a>
                
                <div class="nav-category">Marketing</div>
                <a class="nav-link" data-tab="splash"><i class="fa-solid fa-image"></i> Splash & Banners</a>
                <a class="nav-link" data-tab="coupons"><i class="fa-solid fa-ticket"></i> Coupons</a>
                <a class="nav-link" data-tab="notifications"><i class="fa-solid fa-bell"></i> Notifications</a>
                
                <div class="nav-category">Operations</div>
                <a class="nav-link" data-tab="returns"><i class="fa-solid fa-rotate-left"></i> Returns</a>
                <a class="nav-link" data-tab="settlements"><i class="fa-solid fa-wallet"></i> Settlements</a>
                <a class="nav-link" data-tab="delivery"><i class="fa-solid fa-motorcycle"></i> Delivery Team</a>
                <a class="nav-link" data-tab="drivers"><i class="fa-solid fa-taxi"></i> Driver Tracking</a>
                <a class="nav-link" data-tab="sos"><i class="fa-solid fa-triangle-exclamation"></i> SOS Alerts</a>
                
                <div class="nav-category">System</div>
                <a class="nav-link" data-tab="affiliate"><i class="fa-solid fa-link"></i> Affiliate</a>
                <a class="nav-link" data-tab="locations"><i class="fa-solid fa-map-location-dot"></i> Geo-Fencing</a>
                <a class="nav-link" data-tab="settings"><i class="fa-solid fa-gear"></i> Settings</a>
            </nav>
            <div style="padding: 20px; border-top: 1px solid var(--border);">
                <button id="logout-btn" onclick="logout()" class="btn" style="width: 100%; justify-content: flex-start; color: var(--danger); background: #FEF2F2;">
                    <i class="fa-solid fa-right-from-bracket"></i> Sign Out
                </button>
            </div>
        </div>

        <div id="main-content">
            
            <div class="header-bar">
                <h2 class="page-title">Dashboard</h2>
                <div class="user-profile">
                    <div class="avatar">A</div>
                    <span style="font-weight: 600; font-size: 0.9rem;">Super Admin</span>
                </div>
            </div>

            <div id="categories-section" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Categories Management</h3>
                        <button class="btn btn-primary btn-sm" onclick="openCategoryModal()"><i class="fa-solid fa-plus"></i> Add New</button>
                    </div>
                    <div id="categories-list" class="grid-view" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));"></div>
                </div>
            </div>

            <div id="approvals-section" class="tab-content hidden">
                <div class="card">
                    <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                        <div>
                            <h3>Product Approvals</h3>
                            <small style="color: var(--text-muted);">Manage and review vendor product requests</small>
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <button class="btn btn-dark btn-sm" onclick="toggleSelectAll()"><i class="fa-solid fa-check-double"></i> Select All</button>
                            <select id="approval-status-filter" onchange="fetchProducts()" style="width:auto; margin:0;">
                                <option value="pending" selected>⏳ Pending Review</option>
                                <option value="active">✅ Active / Approved</option>
                                <option value="rejected">❌ Rejected</option>
                            </select>
                            <button class="btn btn-info btn-sm" onclick="fetchProducts()"><i class="fa-solid fa-rotate"></i></button>
                        </div>
                    </div>
                    <div id="approval-grid" class="approval-grid"></div>
                </div>
            </div>

            <div id="splash-section" class="tab-content hidden">
                <div class="form-row">
                    <div class="card" style="flex:1">
                        <div class="card-header"><h3>Upload Splash Screen</h3></div>
                        <form id="splash-form">
                            <input type="file" name="media" accept="image/*" required>
                            <input type="text" name="title" placeholder="Optional Title (e.g. Diwali)">
                            <button class="btn btn-primary" style="width:100%"><i class="fa-solid fa-cloud-arrow-up"></i> Upload</button>
                        </form>
                    </div>
                    <div class="card" style="flex:1">
                        <div class="card-header"><h3>Upload Home Banner</h3></div>
                        <form id="banner-form">
                            <input type="file" name="media" accept="image/*" required>
                            <select name="position">
                                <option value="top">Top Slider</option>
                                <option value="middle">Middle Section</option>
                                <option value="bottom">Bottom Section</option>
                            </select>
                            <select name="section"><option value="home">Home Page</option><option value="product">Product Page</option></select>
                            <button class="btn btn-info" style="width:100%"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Banner</button>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Active Splashes</h3></div>
                    <div id="splash-list" class="grid-view"></div>
                    <div class="card-header" style="margin-top:30px; border-top:1px solid var(--border); padding-top:20px;"><h3>Active Banners</h3></div>
                    <div id="banner-list" class="grid-view"></div>
                </div>
            </div>

            <div id="coupons-section" class="tab-content hidden">
                <div class="card">
                    <div class="card-header"><h3>Create New Coupon</h3></div>
                    <form id="coupon-form">
                        <div class="form-row">
                            <div class="form-group"><label>Coupon Code</label><input name="code" placeholder="e.g. SALE50" required style="text-transform:uppercase; letter-spacing:1px; font-weight:bold;"></div>
                            <div class="form-group"><label>Expiry Date</label><input type="date" name="expiryDate" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Type</label><select name="discountType"><option value="percentage">% Percentage</option><option value="fixed">₹ Fixed Amount</option></select></div>
                            <div class="form-group"><label>Value</label><input type="number" name="discountValue" placeholder="e.g. 20" required></div>
                        </div>
                        <div class="form-row">
                             <div class="form-group"><label>Min Purchase</label><input type="number" name="minPurchaseAmount" placeholder="Optional"></div>
                             <div class="form-group"><label>Max Discount (for %)</label><input type="number" name="maxDiscountAmount" placeholder="Optional"></div>
                        </div>
                        <button class="btn btn-primary"><i class="fa-solid fa-plus"></i> Create Coupon</button>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Active Coupons</h3></div>
                    <div id="coupon-list"></div>
                </div>
            </div>

            <div id="notifications-section" class="tab-content hidden">
                <div class="card" style="max-width:700px; margin:0 auto;">
                    <div class="card-header"><h3><i class="fa-solid fa-paper-plane"></i> Send Push Notification</h3></div>
                    <form id="notify-form">
                        <div class="form-group"><label>Title</label><input name="title" placeholder="Catchy title..." required></div>
                        <div class="form-group"><label>Message Body</label><textarea name="message" rows="4" placeholder="Main content..." required></textarea></div>
                        <div class="form-group"><label>Target Audience</label>
                        <select name="target">
                            <option value="all">Everyone (All Users)</option>
                            <option value="users">Customers Only</option>
                            <option value="sellers">Sellers Only</option>
                            <option value="delivery_boys">Drivers & Delivery</option>
                        </select></div>
                        <div class="form-group"><label>Schedule (Leave empty to send now)</label><input type="datetime-local" name="scheduledAt"></div>
                        <div class="form-group"><label>Image (Optional)</label><input type="file" name="media"></div>
                        <button class="btn btn-success" style="width:100%; margin-top:10px;">Send Notification</button>
                    </form>
                </div>
            </div>

            <div id="returns-section" class="tab-content hidden">
                <div class="card">
                    <div class="card-header"><h3>Return Requests</h3></div>
                    <div class="table-responsive"><table id="returns-table"><thead><tr><th>Order</th><th>User</th><th>Seller</th><th>Amount</th><th>Reason</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>

            <div id="settlements-section" class="tab-content hidden">
                <div class="card">
                    <div class="card-header"><h3>Pending Seller Payouts</h3></div>
                    <div class="table-responsive"><table id="settlements-table"><thead><tr><th>Seller</th><th>Amount</th><th>Bank/UPI Details</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>

            <div id="delivery-section" class="tab-content hidden">
                <div class="card">
                    <div class="card-header"><h3>Registered Delivery Agents</h3></div>
                    <div id="delivery-list" class="grid-view"></div>
                </div>
            </div>

            <div id="drivers-section" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h3>Live Driver Status</h3>
                        <button class="btn btn-info btn-sm" onclick="fetchDrivers()"><i class="fa-solid fa-rotate"></i> Refresh</button>
                    </div>
                    <div class="table-responsive"><table id="drivers-table"><thead><tr><th>Name</th><th>Vehicle</th><th>Phone</th><th>Status</th><th>Wallet</th><th>Action</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>

            <div id="sos-section" class="tab-content hidden">
                <div class="card" style="border-top:4px solid var(--danger);">
                    <div class="card-header" style="border-bottom:none;">
                        <h3 style="color:var(--danger);"><i class="fa-solid fa-triangle-exclamation"></i> Emergency Alerts</h3>
                        <button class="btn btn-danger btn-sm" onclick="fetchSOS()">Refresh</button>
                    </div>
                    <div id="sos-list"></div>
                </div>
            </div>

            <div id="affiliate-section" class="tab-content hidden">
                <div class="card">
                    <div class="card-header"><h3>Add Affiliate Product</h3></div>
                    <form id="affiliate-form">
                        <input type="hidden" id="aff-id">
                        <div class="form-row">
                            <div class="form-group"><label>Name</label><input id="aff-name" required></div>
                            <div class="form-group"><label>Price (₹)</label><input id="aff-price" type="number" required></div>
                        </div>
                        <div class="form-row">
                             <div class="form-group"><label>MRP (Optional)</label><input id="aff-mrp" type="number"></div>
                             <div class="form-group"><label>Platform</label><select id="aff-platform"><option>Amazon</option><option>Flipkart</option><option>Myntra</option><option>Other</option></select></div>
                        </div>
                        <div class="form-group"><label>Affiliate Link</label><input id="aff-link" required></div>
                        <div class="form-group"><label>Description</label><textarea id="aff-desc"></textarea></div>
                        <div class="form-group"><label>Status</label><select id="aff-active"><option value="true">Active</option><option value="false">Inactive</option></select></div>
                        <div class="form-group"><label>Image</label><input type="file" id="aff-img"></div>
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button class="btn btn-primary">Save Product</button>
                            <button type="button" class="btn btn-warning hidden" id="aff-cancel" onclick="resetAffForm()">Cancel Edit</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Affiliate Inventory</h3></div>
                    <div id="affiliate-list" class="grid-view"></div>
                </div>
            </div>

            <div id="locations-section" class="tab-content hidden">
                <div class="card">
                    <div class="card-header"><h3>Blocked Pincodes</h3></div>
                    <div style="display:flex; gap:10px;">
                        <input id="blocked-pins" placeholder="e.g. 800001, 800002" style="margin:0;">
                        <button class="btn btn-primary" onclick="savePincodes()">Save</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Blocked Geo-Zones</h3>
                        <button class="btn btn-danger btn-sm" onclick="openMapModal()"><i class="fa-solid fa-map"></i> Open Map Manager</button>
                    </div>
                    <p style="color:var(--text-muted); font-size:0.9rem;">Current Zones JSON:</p>
                    <textarea id="setting-blocked-zones" rows="4" readonly style="background:#f1f5f9; font-family:monospace; font-size:0.85rem;"></textarea>
                    <button class="btn btn-primary" onclick="saveZonesFromText()" style="margin-top:10px; float:right;">Save Zones</button>
                </div>
            </div>

            <div id="settings-section" class="tab-content hidden">
                <div class="card">
                    <div class="card-header"><h3>System Configuration</h3></div>
                    <div class="form-row">
                        <div class="form-group"><label>Commission (%)</label><input type="number" id="st-comm" step="0.01"></div>
                        <div class="form-group"><label>Product Creation Fee (₹)</label><input type="number" id="st-fee"></div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px; color: var(--text-main);">Delivery Pricing</h4>
                    <div class="form-row">
                        <div class="form-group"><label>Base Charge (₹)</label><input type="number" id="st-base"></div>
                        <div class="form-group"><label>Base Distance (KM)</label><input type="number" id="st-base-km"></div>
                        <div class="form-group"><label>Extra Fee / KM (₹)</label><input type="number" id="st-extra"></div>
                        <div class="form-group"><label>Max Delivery Radius (KM)</label><input type="number" id="st-rad"></div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px; color: var(--text-main);">App Theme</h4>
                    <div class="form-row">
                        <div class="form-group"><label>Primary Color</label><input type="color" id="th-primary" style="height:50px; cursor:pointer;"></div>
                        <div class="form-group"><label>Secondary Color</label><input type="color" id="th-secondary" style="height:50px; cursor:pointer;"></div>
                        <div class="form-group"><label>Background Color</label><input type="color" id="th-bg" style="height:50px; cursor:pointer;"></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()" style="margin-top:15px;">Save All Settings</button>
                </div>
            </div>

        </div> <div id="bulk-bar" class="bulk-bar">
            <span id="bulk-count" class="bulk-count">0 Selected</span>
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2)"></div>
            <button class="btn btn-success btn-sm" onclick="handleBulk(true)">Approve</button>
            <button class="btn btn-danger btn-sm" onclick="handleBulk(false)">Reject</button>
        </div>

    </div> <div id="product-modal" class="modal">
        <div class="modal-content" style="max-width:750px;">
            <button class="close-btn" onclick="closeModal('product-modal')">&times;</button>
            <h3 style="margin-bottom:20px;">Product Details</h3>
            <div id="product-detail-body"></div>
        </div>
    </div>

    <div id="category-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('category-modal')">&times;</button>
            <h3 id="cat-modal-title" style="margin-bottom:20px;">Category</h3>
            <form id="cat-form">
                <input type="hidden" id="cat-id">
                <div class="form-group"><label>Name</label><input id="cat-name" required></div>
                <div class="form-row">
                    <div class="form-group"><label>Type</label><select id="cat-type"><option value="product">Product</option><option value="service">Service</option></select></div>
                    <div class="form-group"><label>Sort Order</label><input id="cat-sort" type="number" value="0"></div>
                </div>
                <div style="background:#f1f5f9; padding:15px; border-radius:12px; margin-bottom:15px;">
                     <h4 style="margin-top:0; font-size:0.9rem;">App Appearance</h4>
                     <div class="form-row">
                         <div class="form-group"><label>Shape</label><select id="cat-shape"><option value="circle">Circle</option><option value="square">Square</option></select></div>
                         <div class="form-group"><label>Bg Color</label><input type="color" id="cat-bg" value="#ffffff" style="height:40px;"></div>
                         <div class="form-group"><label>Text Color</label><input type="color" id="cat-text" value="#000000" style="height:40px;"></div>
                     </div>
                </div>
                <div class="form-group"><label>Status</label><select id="cat-active"><option value="true">Active</option><option value="false">Inactive</option></select></div>
                <div class="form-group"><label>Icon</label><input type="file" id="cat-img"></div>
                <button class="btn btn-primary" style="width:100%;">Save Category</button>
            </form>
        </div>
    </div>

    <div id="subcat-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('subcat-modal')">&times;</button>
            <h3 id="subcat-title" style="margin-bottom:15px;">Subcategories</h3>
            <div style="background:#f1f5f9; padding:15px; border-radius:12px; margin-bottom:15px;">
                <form id="subcat-form" style="display:flex; gap:10px; align-items:flex-end;">
                    <input type="hidden" id="parent-cat-id">
                    <div style="flex:1"><label>Name</label><input id="subcat-name" required></div>
                    <div><label>Image</label><input type="file" id="subcat-img" style="width:110px;" required></div>
                    <button class="btn btn-success" style="height:42px;">Add</button>
                </form>
            </div>
            <div id="subcat-list" style="max-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:8px;"></div>
        </div>
    </div>

    <div id="map-modal" class="modal">
        <div class="modal-content" style="max-width:900px;">
            <button class="close-btn" onclick="closeModal('map-modal')">&times;</button>
            <h3>Manage Blocked Zones</h3>
            <div style="display:flex; gap:20px; margin-top:20px; flex-wrap:wrap;">
                <div style="flex:1; min-width:300px;">
                    <div class="form-group">
                        <label>Search Location</label>
                        <div style="display:flex; gap:10px;"><input id="map-search" placeholder="e.g. Gandhi Maidan"><button class="btn btn-info btn-sm" onclick="searchLocation()">Search</button></div>
                    </div>
                    <button class="btn btn-warning btn-sm" onclick="useLiveLoc()" style="width:100%; margin-bottom:15px;"><i class="fa-solid fa-location-crosshairs"></i> Use My Location</button>
                    <div style="padding:15px; background:#f8fafc; border-radius:12px; border:1px solid var(--border);">
                        <div class="form-group"><label>Reason</label><input id="zone-reason" placeholder="e.g. Heavy Rain"></div>
                        <div class="form-row">
                            <div class="form-group"><label>Lat</label><input id="zone-lat" readonly></div>
                            <div class="form-group"><label>Lng</label><input id="zone-lng" readonly></div>
                        </div>
                        <div class="form-group"><label>Radius: <span id="rad-val">1</span> km</label><input type="range" id="zone-rad" min="0.5" max="10" step="0.5" value="1" oninput="updateCirclePreview()"></div>
                        <button class="btn btn-primary" style="width:100%;" onclick="addZone()">+ Add Zone</button>
                    </div>
                    <ul id="modal-zones-list" style="margin-top:15px; list-style:none; padding:0; max-height:150px; overflow:auto;"></ul>
                </div>
                <div style="flex:1.5; min-width:300px;">
                    <div id="leaflet-map" style="height:450px; border-radius:12px; border:1px solid var(--border);"></div>
                </div>
            </div>
            <button class="btn btn-success" style="float:right; margin-top:20px;" onclick="saveZones()">Save Changes</button>
        </div>
    </div>

    <div id="driver-loc-modal" class="modal">
         <div class="modal-content" style="text-align:center; max-width:400px;">
             <h3 style="margin-bottom:15px;">Driver Location</h3>
             <p id="drv-loc-txt" style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px; font-family:monospace;">Coordinates...</p>
             <a id="drv-map-link" href="#" target="_blank" class="btn btn-info" style="width:100%; margin-bottom:10px;">Open Google Maps</a>
             <button class="btn btn-danger" id="drv-act-btn" style="width:100%;">Block Driver</button>
             <button class="btn btn-warning" onclick="closeModal('driver-loc-modal')" style="width:100%; margin-top:10px;">Close</button>
         </div>
    </div>

    <script>
        // CONFIGURATION
        const API_URL = 'https://hdvideo-1.onrender.com';
        let adminToken = localStorage.getItem('admin_token');

        // --- GLOBAL STATE ---
        let currentProducts = [];
        let selectedProductIds = new Set();
        let tempZones = [];
        let mapInstance = null;
        let previewCircle = null;
        let activeDriverId = null;

        // --- AUTHENTICATION ---
        function checkAuth() {
            if (adminToken) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                fetchProducts(); 
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                const data = await res.json();
                if (res.ok && data.user.role === 'admin') {
                    localStorage.setItem('admin_token', data.token);
                    adminToken = data.token;
                    checkAuth();
                } else {
                    const msg = document.getElementById('login-msg');
                    msg.innerText = data.message || "Login failed";
                    msg.classList.remove('hidden');
                }
            } catch(e) { alert(e.message); }
        });

        function logout() {
            localStorage.removeItem('admin_token');
            location.reload();
        }

        // --- NAVIGATION ---
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                const tabId = link.getAttribute('data-tab');
                document.getElementById(`${tabId}-section`).classList.remove('hidden');
                
                if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');

                if(tabId === 'categories') fetchCategories();
                if(tabId === 'approvals') fetchProducts();
                if(tabId === 'splash') { fetchSplash(); fetchBanners(); }
                if(tabId === 'coupons') fetchCoupons();
                if(tabId === 'returns') fetchReturns();
                if(tabId === 'settlements') fetchSettlements();
                if(tabId === 'delivery') fetchDelivery();
                if(tabId === 'drivers') fetchDrivers();
                if(tabId === 'sos') fetchSOS();
                if(tabId === 'affiliate') fetchAffiliate();
                if(tabId === 'locations') fetchSettings(true); 
                if(tabId === 'settings') fetchSettings();
            });
        });

        // --- API HELPER ---
        async function api(endpoint, method = 'GET', body = null, isFormData = false) {
            const headers = { 'Authorization': `Bearer ${adminToken}` };
            if (body && !isFormData) headers['Content-Type'] = 'application/json';
            
            const opts = { method, headers };
            if (body) opts.body = isFormData ? body : JSON.stringify(body);

            try {
                const res = await fetch(`${API_URL}${endpoint}`, opts);
                if (res.status === 401) { logout(); return; }
                return res;
            } catch(e) { console.error(e); return { ok: false }; }
        }

        // =========================================
        // 1. CATEGORIES
        // =========================================
        async function fetchCategories() {
            const res = await api('/api/admin/categories');
            const data = await res.json();
            const list = document.getElementById('categories-list');
            if(!data.length) list.innerHTML = '<p style="color:var(--text-muted)">No categories found.</p>';
            else list.innerHTML = data.map(c => `
                <div class="approval-card">
                    <div style="display:flex; padding:15px; align-items:center; gap:15px;">
                        <img src="${c.image?.url || 'https://placehold.co/50'}" style="width:50px; height:50px; border-radius:8px; object-fit:cover; border:1px solid var(--border);">
                        <div>
                            <div style="font-weight:700;">${c.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${c.type} • ${c.isActive?'<span style="color:var(--success)">Active</span>':'<span style="color:var(--danger)">Inactive</span>'}</div>
                        </div>
                    </div>
                    <div style="border-top:1px solid var(--border); display:flex;">
                        <button class="card-action-btn" onclick='editCategory(${JSON.stringify(c).replace(/'/g, "&apos;")})'><i class="fa-solid fa-pen"></i> Edit</button>
                        <button class="card-action-btn" style="color:var(--info);" onclick="openSubcats('${c._id}', '${c.name}')"><i class="fa-solid fa-layer-group"></i> Subs</button>
                        <button class="card-action-btn btn-card-reject" onclick="deleteCategory('${c._id}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function openCategoryModal() {
            document.getElementById('cat-form').reset();
            document.getElementById('cat-id').value = '';
            document.getElementById('cat-modal-title').innerText = 'New Category';
            document.getElementById('category-modal').style.display = 'flex';
        }

        function editCategory(c) {
            document.getElementById('cat-id').value = c._id;
            document.getElementById('cat-name').value = c.name;
            document.getElementById('cat-type').value = c.type;
            document.getElementById('cat-sort').value = c.sortOrder || 0;
            document.getElementById('cat-bg').value = c.bgColor || '#ffffff';
            document.getElementById('cat-text').value = c.textColor || '#000000';
            document.getElementById('cat-shape').value = c.shape || 'circle';
            document.getElementById('cat-active').value = c.isActive;
            document.getElementById('cat-modal-title').innerText = 'Edit Category';
            document.getElementById('category-modal').style.display = 'flex';
        }

        document.getElementById('cat-form').addEventListener('submit', async(e) => {
            e.preventDefault();
            const id = document.getElementById('cat-id').value;
            const formData = new FormData();
            formData.append('name', document.getElementById('cat-name').value);
            formData.append('type', document.getElementById('cat-type').value);
            formData.append('sortOrder', document.getElementById('cat-sort').value);
            formData.append('bgColor', document.getElementById('cat-bg').value);
            formData.append('textColor', document.getElementById('cat-text').value);
            formData.append('shape', document.getElementById('cat-shape').value);
            formData.append('isActive', document.getElementById('cat-active').value);
            const file = document.getElementById('cat-img').files[0];
            if(file) formData.append('image', file);

            const endpoint = id ? `/api/admin/categories/${id}` : '/api/admin/categories';
            const method = id ? 'PUT' : 'POST';
            
            const res = await api(endpoint, method, formData, true);
            if(res.ok) { closeModal('category-modal'); fetchCategories(); } else alert('Operation failed');
        });

        async function deleteCategory(id) {
            if(!confirm('Delete this category?')) return;
            await api(`/api/admin/categories/${id}`, 'DELETE');
            fetchCategories();
        }

        function openSubcats(id, name) {
            document.getElementById('subcat-title').innerText = `Subcategories: ${name}`;
            document.getElementById('parent-cat-id').value = id;
            document.getElementById('subcat-modal').style.display = 'flex';
            fetchSubcats(id);
        }

        async function fetchSubcats(parentId) {
            const res = await api(`/api/admin/subcategories?categoryId=${parentId}`);
            const data = await res.json();
            document.getElementById('subcat-list').innerHTML = data.map(s => `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border); align-items:center; background:white;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img src="${s.image?.url}" style="width:35px; height:35px; border-radius:6px; object-fit:cover;">
                        <span style="font-weight:600;">${s.name}</span>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteSubcat('${s._id}')"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        document.getElementById('subcat-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const formData = new FormData();
            formData.append('categoryId', document.getElementById('parent-cat-id').value);
            formData.append('name', document.getElementById('subcat-name').value);
            formData.append('image', document.getElementById('subcat-img').files[0]);
            
            await api('/api/admin/subcategories', 'POST', formData, true);
            document.getElementById('subcat-name').value = '';
            document.getElementById('subcat-img').value = '';
            fetchSubcats(document.getElementById('parent-cat-id').value);
        });

        async function deleteSubcat(id) {
            if(!confirm('Delete?')) return;
            await api(`/api/admin/subcategories/${id}`, 'DELETE');
            fetchSubcats(document.getElementById('parent-cat-id').value);
        }

        // =========================================
        // 2. PRODUCT APPROVALS
        // =========================================
        async function fetchProducts() {
            const status = document.getElementById('approval-status-filter').value;
            const grid = document.getElementById('approval-grid');
            grid.innerHTML = '<p>Loading...</p>';
            selectedProductIds.clear();
            updateBulkUI();

            const res = await api(`/api/admin/products?status=${status}`);
            const products = await res.json();
            currentProducts = products;
            renderProducts(products, status);
        }

        function renderProducts(products, status) {
            const grid = document.getElementById('approval-grid');
            grid.innerHTML = '';
            if(!products.length) { grid.innerHTML = '<p style="color:var(--text-muted)">No products found.</p>'; return; }

            const badgeClass = status === 'pending' ? 'pending' : (status === 'active' ? 'active' : 'rejected');
            
            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'approval-card';
                card.id = `prod-${p._id}`;
                
                const actionsHtml = status === 'pending' ? `
                    <div class="card-actions">
                        <button class="card-action-btn btn-card-reject" onclick="processProduct('${p._id}', false)">Reject</button>
                        <button class="card-action-btn btn-card-approve" onclick="processProduct('${p._id}', true)">Approve</button>
                    </div>
                ` : '';

                card.innerHTML = `
                    <input type="checkbox" class="card-checkbox" value="${p._id}" onchange="toggleSelect('${p._id}')">
                    <span class="card-badge-float status-badge ${badgeClass}">${status}</span>
                    <div class="approval-img-wrapper" onclick="openProductDetail('${p._id}')">
                        <img src="${p.images?.[0]?.url || 'https://placehold.co/200'}" alt="Product">
                        <div class="approval-info-btn"><i class="fa-regular fa-eye"></i></div>
                    </div>
                    <div class="card-body">
                        <div class="card-title">${p.name}</div>
                        <div class="card-meta"><span>${p.brand || 'Generic'}</span><span>Stock: ${p.stock}</span></div>
                        <div class="card-price">₹${p.price}</div>
                        <div style="font-size:0.8rem; margin-top:10px; padding-top:10px; border-top:1px solid #f1f5f9; display:flex; align-items:center; gap:5px;">
                            <i class="fa-solid fa-store" style="color:var(--text-muted)"></i> ${p.seller?.name || 'Unknown Seller'}
                        </div>
                    </div>
                    ${actionsHtml}
                    <div id="overlay-${p._id}" class="approved-overlay hidden"><i class="fa-solid fa-check"></i> UPDATED</div>
                `;
                grid.appendChild(card);
            });
        }

        function toggleSelect(id) {
            if(selectedProductIds.has(id)) selectedProductIds.delete(id); else selectedProductIds.add(id);
            updateBulkUI();
        }
        function toggleSelectAll() {
            const boxes = document.querySelectorAll('.card-checkbox');
            const allSelected = selectedProductIds.size === currentProducts.length;
            selectedProductIds.clear();
            if(!allSelected) currentProducts.forEach(p => selectedProductIds.add(p._id));
            boxes.forEach(b => b.checked = !allSelected);
            updateBulkUI();
        }
        function updateBulkUI() {
            const bar = document.getElementById('bulk-bar');
            document.getElementById('bulk-count').innerText = `${selectedProductIds.size} Selected`;
            if(selectedProductIds.size > 0) bar.classList.add('visible'); else bar.classList.remove('visible');
        }

        async function processProduct(id, approve, skipConf=false) {
            if(!skipConf && !confirm(approve?'Approve product?':'Reject product?')) return;
            const res = await api(`/api/admin/products/${id}/approval`, 'PUT', { isApproved: approve });
            if(res.ok) {
                const card = document.getElementById(`prod-${id}`);
                if(card) {
                    card.classList.add('card-approved-state');
                    document.getElementById(`overlay-${id}`).classList.remove('hidden');
                    setTimeout(() => card.remove(), 800);
                }
            }
        }

        async function handleBulk(approve) {
            if(!confirm(`Bulk ${approve?'Approve':'Reject'} ${selectedProductIds.size} items?`)) return;
            for(let id of selectedProductIds) await processProduct(id, approve, true);
            selectedProductIds.clear();
            updateBulkUI();
            fetchProducts();
        }

        function openProductDetail(id) {
            const p = currentProducts.find(x => x._id === id);
            const body = document.getElementById('product-detail-body');
            const img = p.images?.[0]?.url || 'https://placehold.co/200';
            body.innerHTML = `
                <div style="display:flex; gap:25px; flex-wrap:wrap;">
                    <img src="${img}" style="width:280px; height:280px; object-fit:cover; border-radius:12px; border:1px solid var(--border);">
                    <div style="flex:1;">
                        <span class="status-badge" style="background:var(--info-bg); color:var(--info); margin-bottom:10px;">${p.category?.name || 'N/A'}</span>
                        <h2 style="margin:5px 0;">${p.name}</h2>
                        <h3 style="color:var(--primary); font-size:1.5rem;">₹${p.price} <small style="font-size:0.9rem; color:var(--text-muted); text-decoration:line-through;">₹${p.mrp||''}</small></h3>
                        <p style="background:#f8fafc; padding:15px; border-radius:10px; color:var(--text-muted); line-height:1.6;">${p.description || 'No description provided.'}</p>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                            <div style="border:1px solid var(--border); padding:10px; border-radius:8px;"><strong>Stock</strong><br>${p.stock}</div>
                            <div style="border:1px solid var(--border); padding:10px; border-radius:8px;"><strong>Unit</strong><br>${p.unit||'N/A'}</div>
                        </div>
                        <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border);">
                            <h4 style="margin:0 0 10px;">Seller Info</h4>
                            <div><i class="fa-solid fa-store"></i> ${p.seller?.name || 'N/A'}</div>
                            <div><i class="fa-solid fa-phone"></i> ${p.seller?.phone || 'N/A'}</div>
                            <div><i class="fa-solid fa-envelope"></i> ${p.seller?.email || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('product-modal').style.display = 'flex';
        }

        // =========================================
        // 3. SPLASH & BANNERS
        // =========================================
        async function fetchSplash() {
            const res = await api('/api/admin/splash');
            const data = await res.json();
            document.getElementById('splash-list').innerHTML = data.map(s => `
                <div class="simple-card"><img src="${s.image.url}"><div class="simple-info"><b>${s.title||'No Title'}</b></div><div class="btn-icon-del" onclick="delSplash('${s._id}')"><i class="fa-solid fa-trash"></i></div></div>
            `).join('');
        }
        document.getElementById('splash-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            await api('/api/admin/splash', 'POST', new FormData(e.target), true);
            e.target.reset(); fetchSplash();
        });
        async function delSplash(id) { if(confirm('Delete?')) { await api(`/api/admin/splash/${id}`, 'DELETE'); fetchSplash(); } }

        async function fetchBanners() {
            const res = await api('/api/admin/banners');
            const data = await res.json();
            document.getElementById('banner-list').innerHTML = data.map(b => `
                <div class="simple-card"><img src="${b.image.url}"><div class="simple-info"><span class="status-badge" style="background:#eee; color:#333;">${b.position}</span></div><div class="btn-icon-del" onclick="delBanner('${b._id}')"><i class="fa-solid fa-trash"></i></div></div>
            `).join('');
        }
        document.getElementById('banner-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const fd = new FormData(e.target);
            fd.append('isActive', 'true'); fd.append('type', 'image');
            await api('/api/admin/banners', 'POST', fd, true);
            e.target.reset(); fetchBanners();
        });
        async function delBanner(id) { if(confirm('Delete?')) { await api(`/api/admin/banners/${id}`, 'DELETE'); fetchBanners(); } }

        // =========================================
        // 4. COUPONS
        // =========================================
        async function fetchCoupons() {
            const res = await api('/api/admin/coupons');
            const data = await res.json();
            document.getElementById('coupon-list').innerHTML = data.map(c => `
                <div style="background:white; border:1px solid var(--border); padding:15px; margin-bottom:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; box-shadow:var(--shadow);">
                    <div><strong style="color:var(--primary); font-size:1.1rem; letter-spacing:1px;">${c.code}</strong><br><span style="font-size:0.9rem; color:var(--text-muted);">${c.discountType==='percentage'?c.discountValue+'% OFF':'₹'+c.discountValue+' OFF'}</span></div>
                    <button class="btn btn-danger btn-sm" onclick="delCoupon('${c._id}')"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }
        document.getElementById('coupon-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const fd = new FormData(e.target);
            await api('/api/admin/coupons', 'POST', Object.fromEntries(fd));
            e.target.reset(); fetchCoupons();
        });
        async function delCoupon(id) { if(confirm('Delete?')) { await api(`/api/admin/coupons/${id}`, 'DELETE'); fetchCoupons(); } }

        // =========================================
        // 5. NOTIFICATIONS, RETURNS, SETTLEMENTS
        // =========================================
        document.getElementById('notify-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const fd = new FormData(e.target);
            if(fd.get('scheduledAt')) await api('/api/admin/notifications/schedule', 'POST', fd, true);
            else await api('/api/admin/broadcast', 'POST', fd, true);
            alert('Notification Sent/Scheduled!'); e.target.reset();
        });

        async function fetchReturns() {
            const res = await api('/api/admin/orders');
            const data = await res.json();
            const pending = data.filter(o => o.deliveryStatus.includes('Return'));
            document.querySelector('#returns-table tbody').innerHTML = pending.length ? pending.map(o => `
                <tr>
                    <td><strong>#${o._id.slice(-6)}</strong></td>
                    <td>${o.user?.name}</td>
                    <td>${o.items?.[0]?.product?.seller?.name || 'N/A'}</td>
                    <td>₹${o.totalAmount}</td>
                    <td>${o.refunds?.[0]?.reason||'N/A'}</td>
                    <td><span class="status-badge pending">${o.deliveryStatus}</span></td>
                    <td><button class="btn btn-primary btn-sm" onclick="approveReturn('${o._id}')">Approve</button></td>
                </tr>
            `).join('') : '<tr><td colspan="7" style="text-align:center;">No pending returns</td></tr>';
        }
        async function approveReturn(id) {
            if(confirm('Approve Return & Assign Pickup?')) {
                await api(`/api/admin/orders/${id}/approve-return`, 'POST');
                fetchReturns();
            }
        }

        async function fetchSettlements() {
            const res = await api('/api/admin/payouts/pending');
            const data = await res.json();
            document.querySelector('#settlements-table tbody').innerHTML = data.length ? data.map(s => `
                <tr><td><strong>${s.seller?.name}</strong><br><small>${s.seller?.phone}</small></td><td style="font-weight:bold; color:var(--success);">₹${s.amount}</td><td style="max-width:200px; font-size:0.85rem;">${s.notes}</td><td><span class="status-badge pending">${s.status}</span></td><td><button class="btn btn-success btn-sm" onclick="settle('${s._id}')">Pay</button></td></tr>
            `).join('') : '<tr><td colspan="5" style="text-align:center;">No pending payouts</td></tr>';
        }
        async function settle(id) {
            const txn = prompt('Enter Transaction ID (UTR) to confirm payment:');
            if(txn) {
                await api(`/api/admin/payouts/${id}/process`, 'PUT', {transactionId: txn});
                fetchSettlements();
            }
        }

        // =========================================
        // 6. DELIVERY & DRIVERS
        // =========================================
        async function fetchDelivery() {
            const res = await api('/api/admin/delivery-boys');
            const data = await res.json();
            document.getElementById('delivery-list').innerHTML = data.map(d => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><strong>${d.name}</strong><br><small>${d.phone}</small></div>
                    <div style="text-align:right;"><span class="status-badge active">Pincodes</span><br><small>${d.pincodes.join(', ')}</small></div>
                </div>
            `).join('');
        }

        async function fetchDrivers() {
            const res = await api('/api/admin/drivers-status');
            const data = await res.json();
            document.querySelector('#drivers-table tbody').innerHTML = data.map(d => `
                <tr>
                    <td><strong>${d.name}</strong></td><td>${d.vehicle}</td><td>${d.phone}</td>
                    <td><span class="status-badge" style="background:${d.status.includes('Online')? 'var(--success-bg)':'#f1f5f9'}; color:${d.status.includes('Online')? 'var(--success)':'var(--text-muted)'}">${d.status}</span></td>
                    <td>₹${d.balance}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="showDriverLoc('${d.id}', '${d.location}', '${d.locked}')"><i class="fa-solid fa-gear"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function showDriverLoc(id, loc, lockedStatus) {
            activeDriverId = id;
            document.getElementById('drv-loc-txt').innerText = loc || 'Location Unknown';
            document.getElementById('drv-map-link').href = `https://www.google.com/maps/search/?api=1&query=${loc}`;
            const btn = document.getElementById('drv-act-btn');
            btn.innerText = lockedStatus.includes('Locked') ? 'Unblock Driver' : 'Block Driver';
            btn.className = lockedStatus.includes('Locked') ? 'btn btn-success' : 'btn btn-danger';
            btn.onclick = () => blockDriver(id, lockedStatus);
            document.getElementById('driver-loc-modal').style.display = 'flex';
        }

        async function blockDriver(id, status) {
            const action = status.includes('Locked') ? 'unblock' : 'block';
            await api(`/api/admin/drivers/${id}/block`, 'PUT', {action});
            closeModal('driver-loc-modal');
            fetchDrivers();
        }

        // =========================================
        // 7. SOS & AFFILIATE
        // =========================================
        async function fetchSOS() {
            const res = await api('/api/admin/complaints');
            const data = await res.json();
            const sos = data.filter(c => c.reason?.toLowerCase().includes('sos'));
            document.getElementById('sos-list').innerHTML = sos.length ? sos.map(s => `
                <div class="card" style="border-left:5px solid var(--danger); display:flex; justify-content:space-between; align-items:center;">
                    <div><strong style="color:var(--danger);"><i class="fa-solid fa-bell"></i> SOS ALERT</strong><br>${s.user?.name} (${s.user?.phone})<br><small>${new Date(s.createdAt).toLocaleString()}</small></div>
                    <button class="btn btn-success btn-sm" onclick="resolveSOS('${s._id}')">Resolve</button>
                </div>
            `).join('') : '<p style="text-align:center; color:var(--success);">No Active SOS Alerts</p>';
        }
        async function resolveSOS(id) {
            if(confirm('Mark as Resolved?')) {
                await api(`/api/admin/complaints/${id}/resolve`, 'PUT', {status:'Resolved'});
                fetchSOS();
            }
        }

        async function fetchAffiliate() {
            const res = await api('/api/affiliate-products');
            const data = await res.json();
            document.getElementById('affiliate-list').innerHTML = data.map(a => `
                <div class="simple-card">
                    <img src="${a.image?.url}">
                    <div class="simple-info"><b>${a.name}</b><br><span style="color:var(--primary); font-weight:bold;">₹${a.price}</span></div>
                    <div class="btn-icon-del" onclick="delAffiliate('${a._id}')"><i class="fa-solid fa-trash"></i></div>
                    <button class="btn btn-info btn-sm" style="width:100%; border-radius:0;" onclick='editAff(${JSON.stringify(a).replace(/'/g,"&apos;")})'>Edit</button>
                </div>
            `).join('');
        }
        
        function editAff(a) {
            document.getElementById('aff-id').value = a._id;
            document.getElementById('aff-name').value = a.name;
            document.getElementById('aff-price').value = a.price;
            document.getElementById('aff-link').value = a.affiliateLink;
            document.getElementById('aff-platform').value = a.platform;
            document.getElementById('aff-mrp').value = a.originalPrice || '';
            document.getElementById('aff-desc').value = a.description || '';
            document.getElementById('aff-active').value = a.isActive;
            document.getElementById('aff-cancel').classList.remove('hidden');
        }

        function resetAffForm() {
            document.getElementById('affiliate-form').reset();
            document.getElementById('aff-id').value = '';
            document.getElementById('aff-cancel').classList.add('hidden');
        }

        document.getElementById('affiliate-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const id = document.getElementById('aff-id').value;
            const fd = new FormData();
            fd.append('name', document.getElementById('aff-name').value);
            fd.append('price', document.getElementById('aff-price').value);
            fd.append('affiliateLink', document.getElementById('aff-link').value);
            fd.append('platform', document.getElementById('aff-platform').value);
            fd.append('originalPrice', document.getElementById('aff-mrp').value);
            fd.append('description', document.getElementById('aff-desc').value);
            fd.append('isActive', document.getElementById('aff-active').value);
            if(document.getElementById('aff-img').files[0]) fd.append('media', document.getElementById('aff-img').files[0]);
            
            const endpoint = id ? `/api/admin/affiliate-products/${id}` : '/api/admin/affiliate-products';
            const method = id ? 'PUT' : 'POST';
            
            await api(endpoint, method, fd, true);
            resetAffForm(); fetchAffiliate();
        });
        async function delAffiliate(id) { if(confirm('Del?')) { await api(`/api/admin/affiliate-products/${id}`, 'DELETE'); fetchAffiliate(); } }

        // =========================================
        // 8. MAPS & SETTINGS
        // =========================================
        async function fetchSettings(loadMap=false) {
            const res = await api('/api/admin/settings');
            const data = await res.json();
            
            if(data.deliveryConfig) {
                document.getElementById('blocked-pins').value = data.deliveryConfig.blockedPincodes?.join(', ') || '';
                tempZones = data.deliveryConfig.blockedZones || [];
                renderActiveZonesList();
                
                document.getElementById('st-base').value = data.deliveryConfig.baseCharge;
                document.getElementById('st-base-km').value = data.deliveryConfig.baseKm;
                document.getElementById('st-extra').value = data.deliveryConfig.extraPerKmCharge;
                document.getElementById('st-rad').value = data.deliveryConfig.globalRadiusKm;
            }
            document.getElementById('st-comm').value = data.platformCommissionRate;
            document.getElementById('st-fee').value = data.productCreationFee;
            if(data.theme) {
                document.getElementById('th-primary').value = data.theme.primaryColor;
                document.getElementById('th-secondary').value = data.theme.secondaryColor;
                document.getElementById('th-bg').value = data.theme.backgroundColor;
            }
        }

        async function savePincodes() {
            const pins = document.getElementById('blocked-pins').value;
            await api('/api/admin/settings', 'PUT', { blockedPincodes: pins });
            alert('Saved');
        }

        // Map Logic
        function openMapModal() {
            document.getElementById('map-modal').style.display='flex';
            setTimeout(initMap, 200);
        }
        function initMap() {
            if(mapInstance) mapInstance.remove();
            mapInstance = L.map('leaflet-map').setView([25.5941, 85.1376], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
            
            mapInstance.on('click', e => {
                document.getElementById('zone-lat').value = e.latlng.lat.toFixed(6);
                document.getElementById('zone-lng').value = e.latlng.lng.toFixed(6);
                updateCircle();
            });
            // Draw existing
            tempZones.forEach(z => L.circle([z.lat, z.lng], {radius: z.radiusKm*1000, color:'red', fillOpacity:0.2}).addTo(mapInstance).bindPopup(z.reason));
        }
        
        async function searchLocation() {
            const q = document.getElementById('map-search').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const data = await res.json();
            if(data.length) {
                const {lat, lon} = data[0];
                mapInstance.setView([lat, lon], 14);
                document.getElementById('zone-lat').value = lat;
                document.getElementById('zone-lng').value = lon;
                updateCircle();
            }
        }

        function useLiveLoc() {
            navigator.geolocation.getCurrentPosition(pos => {
                const {latitude, longitude} = pos.coords;
                mapInstance.setView([latitude, longitude], 15);
                document.getElementById('zone-lat').value = latitude;
                document.getElementById('zone-lng').value = longitude;
                updateCircle();
            });
        }

        function updateCircle() {
            const lat = document.getElementById('zone-lat').value;
            const lng = document.getElementById('zone-lng').value;
            const rad = document.getElementById('zone-rad').value;
            document.getElementById('rad-val').innerText = rad;
            if(previewCircle) mapInstance.removeLayer(previewCircle);
            if(lat && lng) previewCircle = L.circle([lat, lng], {radius: rad*1000, color:'blue', fillOpacity:0.1}).addTo(mapInstance);
        }

        function addZone() {
            const lat = document.getElementById('zone-lat').value;
            const lng = document.getElementById('zone-lng').value;
            const rad = document.getElementById('zone-rad').value;
            const reason = document.getElementById('zone-reason').value;
            if(lat && reason) {
                tempZones.push({lat: parseFloat(lat), lng: parseFloat(lng), radiusKm: parseFloat(rad), reason});
                L.circle([lat, lng], {radius: rad*1000, color:'red', fillOpacity:0.2}).addTo(mapInstance);
                renderModalZonesList();
                document.getElementById('zone-reason').value = '';
            } else alert("Select location & enter reason");
        }

        async function saveZones() {
            await api('/api/admin/settings', 'PUT', { blockedZones: JSON.stringify(tempZones) });
            closeModal('map-modal');
            renderActiveZonesList();
            alert('Zones Updated');
        }
        
        function saveZonesFromText() {
             try {
                const zones = JSON.parse(document.getElementById('setting-blocked-zones').value);
                api('/api/admin/settings', 'PUT', { blockedZones: JSON.stringify(zones) });
                alert('Saved');
             } catch(e) { alert('Invalid JSON'); }
        }

        function renderModalZonesList() {
            document.getElementById('modal-zones-list').innerHTML = tempZones.map((z, i) => `<li>${z.reason} (${z.radiusKm}km) <button class="btn btn-danger btn-sm" onclick="tempZones.splice(${i},1); renderModalZonesList()" style="padding:2px 6px;">x</button></li>`).join('');
        }
        function renderActiveZonesList() {
            document.getElementById('setting-blocked-zones').value = JSON.stringify(tempZones, null, 2);
        }

        async function saveSettings() {
            const body = {
                platformCommissionRate: document.getElementById('st-comm').value,
                productCreationFee: document.getElementById('st-fee').value,
                deliveryBaseCharge: document.getElementById('st-base').value,
                deliveryBaseKm: document.getElementById('st-base-km').value,
                deliveryPerKmCharge: document.getElementById('st-extra').value,
                deliveryRadius: document.getElementById('st-rad').value,
                theme: {
                    primaryColor: document.getElementById('th-primary').value,
                    secondaryColor: document.getElementById('th-secondary').value,
                    backgroundColor: document.getElementById('th-bg').value
                }
            };
            await api('/api/admin/settings', 'PUT', body);
            alert('Settings Saved');
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // Initial Auth Check
        checkAuth();

    </script>
</body>
</html>
